{
    "instance": {
        "name": "pttepdev",
        "url": "https://pttepdev.service-now.com",
        "g_ck": "9bbc526a9761ba90c4ea79b71153af66482c26f000a2c4b4a8269e9e6f54b8a218dc3322"
    },
    "action": "saveWidget",
    "tableName": "sp_widget",
    "name": "IStationery Stock-In Order NOW",
    "sys_id": "31d7e7e7db217190d63d06a5f39619c2",
    "widget": {
        "template": {
            "sys_mandatory": false,
            "visible": true,
            "dbType": -1,
            "label": "Body HTML template",
            "sys_readonly": false,
            "type": "html_template",
            "mandatory": false,
            "displayValue": "<div class=\"row\">\r\n\t<div\r\n\t\tclass=\"column\"\r\n\t\tstyle=\"\r\n\t\t\tfloat: left;\r\n\t\t\tpadding-left: 15px;\r\n\t\t\tpadding-right: 20px;\r\n\t\t\tpadding-bottom: 20px;\r\n\t\t\tmargin-top: -10px;\r\n\t\t\"\r\n\t\tdir=\"ltr\">\r\n\t\t<button\r\n\t\t\ttype=\"button\"\r\n\t\t\tclass=\"btn btn-primary\"\r\n\t\t\tdata-toggle=\"modal\"\r\n\t\t\tdata-target=\"#myModal\"\r\n\t\t\tng-click=\"c.copyArray()\">\r\n\t\t\tOrder Now\r\n\t\t</button>\r\n\t</div>\r\n\t<div\r\n\t\tclass=\"column\"\r\n\t\tstyle=\"float: right; padding-right: 15px; padding-bottom: 20px; margin-top: -10px\"\r\n\t\tdir=\"rtl\">\r\n\t\t<button\r\n\t\t\ttype=\"button\"\r\n\t\t\tid=\"istationary_stock_in_item_list_cart\"\r\n\t\t\tclass=\"btn btn-primary\"\r\n\t\t\tdata-toggle=\"modal\"\r\n\t\t\tdata-target=\"#myPreviewModal\"\r\n\t\t\tng-click=\"c.fetchObjectValue()\">\r\n\t\t\tPreview Order\r\n\t\t</button>\r\n\t</div>\r\n</div>\r\n\r\n<div id=\"myModal\" class=\"modal fade\" data-backdrop=\"static\" data-keyboard=\"false\" role=\"dialog\">\r\n\t<div class=\"modal-dialog\">\r\n\t\t<div class=\"modal-content\">\r\n\t\t\t<div class=\"modal-header\">\r\n\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\">&times;</button>\r\n\t\t\t\t<h3 class=\"modal-title\">iStationary Stock-In</h3>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"modal-body\">\r\n\t\t\t\t<table\r\n\t\t\t\t\tclass=\"table table-hover table-striped table-responsive table-bordered table-wrapper-scroll-y my-custom-scrollbar\">\r\n\t\t\t\t\t<thead>\r\n\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t<th style=\"width: 15%; text-align: center\" class=\"tablecolumn\">Item</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 30%; text-align: center\" class=\"tablecolumn\">Description</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 10%; text-align: center\" class=\"tablecolumn\">Unit Type</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 12%; text-align: center\" class=\"tablecolumn\">Unit Price</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 12%; text-align: center\" class=\"tablecolumn\">Edit Price</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 10%; text-align: center\" class=\"tablecolumn\">Quantity</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 16%; text-align: center\" class=\"tablecolumn\">Total Price</th>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t</thead>\r\n\t\t\t\t\t<tbody>\r\n\t\t\t\t\t\t<!---<tr dir-paginate=\"item in filteredItems = c.copyArr | itemsPerPage:15\" current-page=\"c.currentPage\" pagination-id=\"active\">--->\r\n\t\t\t\t\t\t<tr ng-if=\"c.copyArr.length <= 0\" current-page=\"c.currentPage\" pagination-id=\"active\">\r\n\t\t\t\t\t\t\t<td colspan=\"7  \" style=\"text-align: center\">Empty Item</td>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t\t<tr\r\n\t\t\t\t\t\t\tng-repeat=\"item in c.copyArr\"\r\n\t\t\t\t\t\t\t*ngIf=\"c.copyArr.length > 0\"\r\n\t\t\t\t\t\t\tcurrent-page=\"c.currentPage\"\r\n\t\t\t\t\t\t\tpagination-id=\"active\">\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">\r\n\t\t\t\t\t\t\t\t<a href=\"{{::item.photo1}}\" target=\"_blank\">\r\n\t\t\t\t\t\t\t\t\t<img\r\n\t\t\t\t\t\t\t\t\t\tng-src=\"{{::item.photo1}}?t=large\"\r\n\t\t\t\t\t\t\t\t\t\tng-if=\"item.photo1\"\r\n\t\t\t\t\t\t\t\t\t\talt=\"{{::item.name}}\"\r\n\t\t\t\t\t\t\t\t\t\tclass=\"m-r-sm m-b-sm item-image pull-center\"\r\n\t\t\t\t\t\t\t\t\t\tng-click=\"showLargeImage(item.photo1x)\" />\r\n\t\t\t\t\t\t\t\t</a>\r\n\t\t\t\t\t\t\t\t<a>\r\n\t\t\t\t\t\t\t\t\t<img\r\n\t\t\t\t\t\t\t\t\t\tng-src=\"No%20Image.png?t=large\"\r\n\t\t\t\t\t\t\t\t\t\tng-if=\"item.photo1 === 'null.iix'\"\r\n\t\t\t\t\t\t\t\t\t\talt=\"{{::item.name}}\"\r\n\t\t\t\t\t\t\t\t\t\tclass=\"m-r-sm m-b-sm item-image pull-center\"\r\n\t\t\t\t\t\t\t\t\t\tng-click=\"showLargeImage(item.photo1x)\" />\r\n\t\t\t\t\t\t\t\t</a>\r\n\t\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t\t<td>{{item.description}}</td>\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">{{item.unit_type}}</td>\r\n\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">{{item.stock_in_unit_cost}}</td>\r\n\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">\r\n\t\t\t\t\t\t\t\t<!-- Can edit when has PO -->\r\n\t\t\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t\t\tng-show=\"item.editable\"\r\n\t\t\t\t\t\t\t\t\ttype=\"number\"\r\n\t\t\t\t\t\t\t\t\tname=\"unit_price\"\r\n\t\t\t\t\t\t\t\t\tng-model=\"item.unit_price\"\r\n\t\t\t\t\t\t\t\t\tmin=\"0\"\r\n\t\t\t\t\t\t\t\t\tstep=\"0.01\"\r\n\t\t\t\t\t\t\t\t\trequired\r\n\t\t\t\t\t\t\t\t\tng-disabled=\"!item.editable\"\r\n\t\t\t\t\t\t\t\t\tng-change=\"updatePrice(item)\"\r\n\t\t\t\t\t\t\t\t\tstyle=\"text-align: center\"\r\n\t\t\t\t\t\t\t\t\tclass=\"rounded-corner-input example1 column1\" />\r\n\r\n\t\t\t\t\t\t\t\t<!-- Can't edit when has PO -->\r\n\t\t\t\t\t\t\t\t<span ng-show=\"!item.editable\">{{ item.unit_price }}</span>\r\n\t\t\t\t\t\t\t</td>\r\n\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">\r\n\t\t\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t\t\tstyle=\"text-align: center\"\r\n\t\t\t\t\t\t\t\t\tclass=\"rounded-corner-input example1 column1\"\r\n\t\t\t\t\t\t\t\t\tng-model=\"item.qty\"\r\n\t\t\t\t\t\t\t\t\ttype=\"number\"\r\n\t\t\t\t\t\t\t\t\tng-change=\"updatePrice(item)\"\r\n\t\t\t\t\t\t\t\t\tmin=\"0\" />\r\n\t\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">\r\n\t\t\t\t\t\t\t\t฿\r\n\t\t\t\t\t\t\t\t<label ng-bind=\"item.totalPrice\"></label>\r\n\t\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t</tbody>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"modal-footer\">\r\n\t\t\t\t<button class=\"btn btn-primary\" ng-click=\"c.generateArray()\">${Add}</button>\r\n\t\t\t\t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Close</button>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n\r\n<div\r\n\tid=\"myPreviewModal\"\r\n\tclass=\"modal fade\"\r\n\tdata-backdrop=\"static\"\r\n\tdata-keyboard=\"false\"\r\n\trole=\"dialog\">\r\n\t<div class=\"modal-dialog\">\r\n\t\t<div class=\"modal-content\">\r\n\t\t\t<div class=\"modal-header\">\r\n\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\">&times;</button>\r\n\t\t\t\t<h3 class=\"modal-title\">iStationary Stock-In (Order Summary)</h3>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"modal-body\">\r\n\t\t\t\t<table\r\n\t\t\t\t\tclass=\"table table-hover table-striped table-responsive table-bordered table-wrapper-scroll-y my-custom-scrollbar\">\r\n\t\t\t\t\t<thead>\r\n\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t<th style=\"width: 15%; text-align: center\" class=\"tablecolumn\">Item</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 30%; text-align: center\" class=\"tablecolumn\">Description</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 10%; text-align: center\" class=\"tablecolumn\">Unit Type</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 12%; text-align: center\" class=\"tablecolumn\">Unit Price</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 12%; text-align: center\" class=\"tablecolumn\">Edit Price</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 10%; text-align: center\" class=\"tablecolumn\">Quantity</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 16%; text-align: center\" class=\"tablecolumn\">Total Price</th>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t</thead>\r\n\t\t\t\t\t<tbody>\r\n\t\t\t\t\t\t<tr\r\n\t\t\t\t\t\t\tng-if=\"c.previewOBJ.length <= 0\"\r\n\t\t\t\t\t\t\tcurrent-page=\"c.currentPage\"\r\n\t\t\t\t\t\t\tpagination-id=\"active\">\r\n\t\t\t\t\t\t\t<td colspan=\"7\" style=\"text-align: center\">Empty Item</td>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t\t<tr\r\n\t\t\t\t\t\t\tng-repeat=\"item in c.previewOBJ\"\r\n\t\t\t\t\t\t\t*ngIf=\"c.previewOBJ.length > 0\"\r\n\t\t\t\t\t\t\tcurrent-page=\"c.currentPage\"\r\n\t\t\t\t\t\t\tpagination-id=\"active\">\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">\r\n\t\t\t\t\t\t\t\t<a href=\"{{::item.photo1}}\" target=\"_blank\">\r\n\t\t\t\t\t\t\t\t\t<img\r\n\t\t\t\t\t\t\t\t\t\tng-src=\"{{::item.photo1}}?t=large\"\r\n\t\t\t\t\t\t\t\t\t\tng-if=\"item.photo1\"\r\n\t\t\t\t\t\t\t\t\t\talt=\"{{::item.name}}\"\r\n\t\t\t\t\t\t\t\t\t\tclass=\"m-r-sm m-b-sm item-image pull-center\"\r\n\t\t\t\t\t\t\t\t\t\tng-click=\"showLargeImage(item.photo1x)\" />\r\n\t\t\t\t\t\t\t\t</a>\r\n\t\t\t\t\t\t\t\t<a>\r\n\t\t\t\t\t\t\t\t\t<img\r\n\t\t\t\t\t\t\t\t\t\tng-src=\"No%20Image.png?t=large\"\r\n\t\t\t\t\t\t\t\t\t\tng-if=\"item.photo1 === 'null.iix'\"\r\n\t\t\t\t\t\t\t\t\t\talt=\"{{::item.name}}\"\r\n\t\t\t\t\t\t\t\t\t\tclass=\"m-r-sm m-b-sm item-image pull-center\"\r\n\t\t\t\t\t\t\t\t\t\tng-click=\"showLargeImage(item.photo1x)\" />\r\n\t\t\t\t\t\t\t\t</a>\r\n\t\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t\t<td style=\"text-align: left\">{{item.description}}</td>\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">{{item.unit_type}}</td>\r\n\t\t\t\t\t\t\t<!-- <td style=\"text-align: center\">{{item.unit_price}}</td> -->\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">{{item.stock_in_unit_cost}}</td>\r\n\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">\r\n\t\t\t\t\t\t\t\t<!-- Can edit when has PO -->\r\n\t\t\t\t\t\t\t\t<!-- <input\r\n\t\t\t\t\t\t\t\t\tng-if=\"item.editable\"\r\n\t\t\t\t\t\t\t\t\tstyle=\"text-align: center\"\r\n\t\t\t\t\t\t\t\t\tclass=\"rounded-corner-input example1 column1\"\r\n\t\t\t\t\t\t\t\t\tng-model=\"item.unit_price\"\r\n\t\t\t\t\t\t\t\t\ttype=\"number\"\r\n\t\t\t\t\t\t\t\t\tname=\"unit_price\"\r\n\t\t\t\t\t\t\t\t\tmin=\"0\" /> -->\r\n\r\n\t\t\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t\t\tng-show=\"item.editable\"\r\n\t\t\t\t\t\t\t\t\ttype=\"number\"\r\n\t\t\t\t\t\t\t\t\tname=\"unit_price\"\r\n\t\t\t\t\t\t\t\t\tng-model=\"item.unit_price\"\r\n\t\t\t\t\t\t\t\t\tmin=\"0\"\r\n\t\t\t\t\t\t\t\t\tstep=\"0.01\"\r\n\t\t\t\t\t\t\t\t\trequired\r\n\t\t\t\t\t\t\t\t\tng-disabled=\"!item.editable\"\r\n\t\t\t\t\t\t\t\t\tng-change=\"updatePrice(item)\"\r\n\t\t\t\t\t\t\t\t\tstyle=\"text-align: center\"\r\n\t\t\t\t\t\t\t\t\tclass=\"rounded-corner-input example1 column1\" />\r\n\r\n\t\t\t\t\t\t\t\t<!-- Can't edit when has PO -->\r\n\t\t\t\t\t\t\t\t<span ng-show=\"!item.editable\">{{ item.unit_price }}</span>\r\n\t\t\t\t\t\t\t</td>\r\n\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">\r\n\t\t\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t\t\tstyle=\"text-align: center\"\r\n\t\t\t\t\t\t\t\t\tclass=\"rounded-corner-input example1 column1\"\r\n\t\t\t\t\t\t\t\t\tng-model=\"item.qty\"\r\n\t\t\t\t\t\t\t\t\ttype=\"number\"\r\n\t\t\t\t\t\t\t\t\tng-change=\"updatePrice(item)\"\r\n\t\t\t\t\t\t\t\t\tmin=\"0\" />\r\n\t\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">\r\n\t\t\t\t\t\t\t\t฿\r\n\t\t\t\t\t\t\t\t<label ng-bind=\"item.totalPrice\"></label>\r\n\t\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t</tbody>\r\n\t\t\t\t</table>\r\n\t\t\t\t<p style=\"text-align: right; padding-right: 18px\">Grand Price: ฿{{c.total_display}}</p>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"modal-footer\">\r\n\t\t\t\t<button class=\"btn btn-primary\" ng-click=\"c.updateCart()\">${Update}</button>\r\n\t\t\t\t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Close</button>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n",
            "readonly": false,
            "hint": "",
            "name": "template",
            "attributes": {},
            "choice": 0,
            "value": "<div class=\"row\">\r\n\t<div\r\n\t\tclass=\"column\"\r\n\t\tstyle=\"\r\n\t\t\tfloat: left;\r\n\t\t\tpadding-left: 15px;\r\n\t\t\tpadding-right: 20px;\r\n\t\t\tpadding-bottom: 20px;\r\n\t\t\tmargin-top: -10px;\r\n\t\t\"\r\n\t\tdir=\"ltr\">\r\n\t\t<button\r\n\t\t\ttype=\"button\"\r\n\t\t\tclass=\"btn btn-primary\"\r\n\t\t\tdata-toggle=\"modal\"\r\n\t\t\tdata-target=\"#myModal\"\r\n\t\t\tng-click=\"c.copyArray()\">\r\n\t\t\tOrder Now\r\n\t\t</button>\r\n\t</div>\r\n\t<div\r\n\t\tclass=\"column\"\r\n\t\tstyle=\"float: right; padding-right: 15px; padding-bottom: 20px; margin-top: -10px\"\r\n\t\tdir=\"rtl\">\r\n\t\t<button\r\n\t\t\ttype=\"button\"\r\n\t\t\tid=\"istationary_stock_in_item_list_cart\"\r\n\t\t\tclass=\"btn btn-primary\"\r\n\t\t\tdata-toggle=\"modal\"\r\n\t\t\tdata-target=\"#myPreviewModal\"\r\n\t\t\tng-click=\"c.fetchObjectValue()\">\r\n\t\t\tPreview Order\r\n\t\t</button>\r\n\t</div>\r\n</div>\r\n\r\n<div id=\"myModal\" class=\"modal fade\" data-backdrop=\"static\" data-keyboard=\"false\" role=\"dialog\">\r\n\t<div class=\"modal-dialog\">\r\n\t\t<div class=\"modal-content\">\r\n\t\t\t<div class=\"modal-header\">\r\n\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\">&times;</button>\r\n\t\t\t\t<h3 class=\"modal-title\">iStationary Stock-In</h3>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"modal-body\">\r\n\t\t\t\t<table\r\n\t\t\t\t\tclass=\"table table-hover table-striped table-responsive table-bordered table-wrapper-scroll-y my-custom-scrollbar\">\r\n\t\t\t\t\t<thead>\r\n\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t<th style=\"width: 15%; text-align: center\" class=\"tablecolumn\">Item</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 30%; text-align: center\" class=\"tablecolumn\">Description</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 10%; text-align: center\" class=\"tablecolumn\">Unit Type</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 12%; text-align: center\" class=\"tablecolumn\">Unit Price</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 12%; text-align: center\" class=\"tablecolumn\">Edit Price</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 10%; text-align: center\" class=\"tablecolumn\">Quantity</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 16%; text-align: center\" class=\"tablecolumn\">Total Price</th>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t</thead>\r\n\t\t\t\t\t<tbody>\r\n\t\t\t\t\t\t<!---<tr dir-paginate=\"item in filteredItems = c.copyArr | itemsPerPage:15\" current-page=\"c.currentPage\" pagination-id=\"active\">--->\r\n\t\t\t\t\t\t<tr ng-if=\"c.copyArr.length <= 0\" current-page=\"c.currentPage\" pagination-id=\"active\">\r\n\t\t\t\t\t\t\t<td colspan=\"7  \" style=\"text-align: center\">Empty Item</td>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t\t<tr\r\n\t\t\t\t\t\t\tng-repeat=\"item in c.copyArr\"\r\n\t\t\t\t\t\t\t*ngIf=\"c.copyArr.length > 0\"\r\n\t\t\t\t\t\t\tcurrent-page=\"c.currentPage\"\r\n\t\t\t\t\t\t\tpagination-id=\"active\">\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">\r\n\t\t\t\t\t\t\t\t<a href=\"{{::item.photo1}}\" target=\"_blank\">\r\n\t\t\t\t\t\t\t\t\t<img\r\n\t\t\t\t\t\t\t\t\t\tng-src=\"{{::item.photo1}}?t=large\"\r\n\t\t\t\t\t\t\t\t\t\tng-if=\"item.photo1\"\r\n\t\t\t\t\t\t\t\t\t\talt=\"{{::item.name}}\"\r\n\t\t\t\t\t\t\t\t\t\tclass=\"m-r-sm m-b-sm item-image pull-center\"\r\n\t\t\t\t\t\t\t\t\t\tng-click=\"showLargeImage(item.photo1x)\" />\r\n\t\t\t\t\t\t\t\t</a>\r\n\t\t\t\t\t\t\t\t<a>\r\n\t\t\t\t\t\t\t\t\t<img\r\n\t\t\t\t\t\t\t\t\t\tng-src=\"No%20Image.png?t=large\"\r\n\t\t\t\t\t\t\t\t\t\tng-if=\"item.photo1 === 'null.iix'\"\r\n\t\t\t\t\t\t\t\t\t\talt=\"{{::item.name}}\"\r\n\t\t\t\t\t\t\t\t\t\tclass=\"m-r-sm m-b-sm item-image pull-center\"\r\n\t\t\t\t\t\t\t\t\t\tng-click=\"showLargeImage(item.photo1x)\" />\r\n\t\t\t\t\t\t\t\t</a>\r\n\t\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t\t<td>{{item.description}}</td>\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">{{item.unit_type}}</td>\r\n\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">{{item.stock_in_unit_cost}}</td>\r\n\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">\r\n\t\t\t\t\t\t\t\t<!-- Can edit when has PO -->\r\n\t\t\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t\t\tng-show=\"item.editable\"\r\n\t\t\t\t\t\t\t\t\ttype=\"number\"\r\n\t\t\t\t\t\t\t\t\tname=\"unit_price\"\r\n\t\t\t\t\t\t\t\t\tng-model=\"item.unit_price\"\r\n\t\t\t\t\t\t\t\t\tmin=\"0\"\r\n\t\t\t\t\t\t\t\t\tstep=\"0.01\"\r\n\t\t\t\t\t\t\t\t\trequired\r\n\t\t\t\t\t\t\t\t\tng-disabled=\"!item.editable\"\r\n\t\t\t\t\t\t\t\t\tng-change=\"updatePrice(item)\"\r\n\t\t\t\t\t\t\t\t\tstyle=\"text-align: center\"\r\n\t\t\t\t\t\t\t\t\tclass=\"rounded-corner-input example1 column1\" />\r\n\r\n\t\t\t\t\t\t\t\t<!-- Can't edit when has PO -->\r\n\t\t\t\t\t\t\t\t<span ng-show=\"!item.editable\">{{ item.unit_price }}</span>\r\n\t\t\t\t\t\t\t</td>\r\n\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">\r\n\t\t\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t\t\tstyle=\"text-align: center\"\r\n\t\t\t\t\t\t\t\t\tclass=\"rounded-corner-input example1 column1\"\r\n\t\t\t\t\t\t\t\t\tng-model=\"item.qty\"\r\n\t\t\t\t\t\t\t\t\ttype=\"number\"\r\n\t\t\t\t\t\t\t\t\tng-change=\"updatePrice(item)\"\r\n\t\t\t\t\t\t\t\t\tmin=\"0\" />\r\n\t\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">\r\n\t\t\t\t\t\t\t\t฿\r\n\t\t\t\t\t\t\t\t<label ng-bind=\"item.totalPrice\"></label>\r\n\t\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t</tbody>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"modal-footer\">\r\n\t\t\t\t<button class=\"btn btn-primary\" ng-click=\"c.generateArray()\">${Add}</button>\r\n\t\t\t\t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Close</button>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n\r\n<div\r\n\tid=\"myPreviewModal\"\r\n\tclass=\"modal fade\"\r\n\tdata-backdrop=\"static\"\r\n\tdata-keyboard=\"false\"\r\n\trole=\"dialog\">\r\n\t<div class=\"modal-dialog\">\r\n\t\t<div class=\"modal-content\">\r\n\t\t\t<div class=\"modal-header\">\r\n\t\t\t\t<button type=\"button\" class=\"close\" data-dismiss=\"modal\">&times;</button>\r\n\t\t\t\t<h3 class=\"modal-title\">iStationary Stock-In (Order Summary)</h3>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"modal-body\">\r\n\t\t\t\t<table\r\n\t\t\t\t\tclass=\"table table-hover table-striped table-responsive table-bordered table-wrapper-scroll-y my-custom-scrollbar\">\r\n\t\t\t\t\t<thead>\r\n\t\t\t\t\t\t<tr>\r\n\t\t\t\t\t\t\t<th style=\"width: 15%; text-align: center\" class=\"tablecolumn\">Item</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 30%; text-align: center\" class=\"tablecolumn\">Description</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 10%; text-align: center\" class=\"tablecolumn\">Unit Type</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 12%; text-align: center\" class=\"tablecolumn\">Unit Price</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 12%; text-align: center\" class=\"tablecolumn\">Edit Price</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 10%; text-align: center\" class=\"tablecolumn\">Quantity</th>\r\n\t\t\t\t\t\t\t<th style=\"width: 16%; text-align: center\" class=\"tablecolumn\">Total Price</th>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t</thead>\r\n\t\t\t\t\t<tbody>\r\n\t\t\t\t\t\t<tr\r\n\t\t\t\t\t\t\tng-if=\"c.previewOBJ.length <= 0\"\r\n\t\t\t\t\t\t\tcurrent-page=\"c.currentPage\"\r\n\t\t\t\t\t\t\tpagination-id=\"active\">\r\n\t\t\t\t\t\t\t<td colspan=\"7\" style=\"text-align: center\">Empty Item</td>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t\t<tr\r\n\t\t\t\t\t\t\tng-repeat=\"item in c.previewOBJ\"\r\n\t\t\t\t\t\t\t*ngIf=\"c.previewOBJ.length > 0\"\r\n\t\t\t\t\t\t\tcurrent-page=\"c.currentPage\"\r\n\t\t\t\t\t\t\tpagination-id=\"active\">\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">\r\n\t\t\t\t\t\t\t\t<a href=\"{{::item.photo1}}\" target=\"_blank\">\r\n\t\t\t\t\t\t\t\t\t<img\r\n\t\t\t\t\t\t\t\t\t\tng-src=\"{{::item.photo1}}?t=large\"\r\n\t\t\t\t\t\t\t\t\t\tng-if=\"item.photo1\"\r\n\t\t\t\t\t\t\t\t\t\talt=\"{{::item.name}}\"\r\n\t\t\t\t\t\t\t\t\t\tclass=\"m-r-sm m-b-sm item-image pull-center\"\r\n\t\t\t\t\t\t\t\t\t\tng-click=\"showLargeImage(item.photo1x)\" />\r\n\t\t\t\t\t\t\t\t</a>\r\n\t\t\t\t\t\t\t\t<a>\r\n\t\t\t\t\t\t\t\t\t<img\r\n\t\t\t\t\t\t\t\t\t\tng-src=\"No%20Image.png?t=large\"\r\n\t\t\t\t\t\t\t\t\t\tng-if=\"item.photo1 === 'null.iix'\"\r\n\t\t\t\t\t\t\t\t\t\talt=\"{{::item.name}}\"\r\n\t\t\t\t\t\t\t\t\t\tclass=\"m-r-sm m-b-sm item-image pull-center\"\r\n\t\t\t\t\t\t\t\t\t\tng-click=\"showLargeImage(item.photo1x)\" />\r\n\t\t\t\t\t\t\t\t</a>\r\n\t\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t\t<td style=\"text-align: left\">{{item.description}}</td>\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">{{item.unit_type}}</td>\r\n\t\t\t\t\t\t\t<!-- <td style=\"text-align: center\">{{item.unit_price}}</td> -->\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">{{item.stock_in_unit_cost}}</td>\r\n\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">\r\n\t\t\t\t\t\t\t\t<!-- Can edit when has PO -->\r\n\t\t\t\t\t\t\t\t<!-- <input\r\n\t\t\t\t\t\t\t\t\tng-if=\"item.editable\"\r\n\t\t\t\t\t\t\t\t\tstyle=\"text-align: center\"\r\n\t\t\t\t\t\t\t\t\tclass=\"rounded-corner-input example1 column1\"\r\n\t\t\t\t\t\t\t\t\tng-model=\"item.unit_price\"\r\n\t\t\t\t\t\t\t\t\ttype=\"number\"\r\n\t\t\t\t\t\t\t\t\tname=\"unit_price\"\r\n\t\t\t\t\t\t\t\t\tmin=\"0\" /> -->\r\n\r\n\t\t\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t\t\tng-show=\"item.editable\"\r\n\t\t\t\t\t\t\t\t\ttype=\"number\"\r\n\t\t\t\t\t\t\t\t\tname=\"unit_price\"\r\n\t\t\t\t\t\t\t\t\tng-model=\"item.unit_price\"\r\n\t\t\t\t\t\t\t\t\tmin=\"0\"\r\n\t\t\t\t\t\t\t\t\tstep=\"0.01\"\r\n\t\t\t\t\t\t\t\t\trequired\r\n\t\t\t\t\t\t\t\t\tng-disabled=\"!item.editable\"\r\n\t\t\t\t\t\t\t\t\tng-change=\"updatePrice(item)\"\r\n\t\t\t\t\t\t\t\t\tstyle=\"text-align: center\"\r\n\t\t\t\t\t\t\t\t\tclass=\"rounded-corner-input example1 column1\" />\r\n\r\n\t\t\t\t\t\t\t\t<!-- Can't edit when has PO -->\r\n\t\t\t\t\t\t\t\t<span ng-show=\"!item.editable\">{{ item.unit_price }}</span>\r\n\t\t\t\t\t\t\t</td>\r\n\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">\r\n\t\t\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t\t\tstyle=\"text-align: center\"\r\n\t\t\t\t\t\t\t\t\tclass=\"rounded-corner-input example1 column1\"\r\n\t\t\t\t\t\t\t\t\tng-model=\"item.qty\"\r\n\t\t\t\t\t\t\t\t\ttype=\"number\"\r\n\t\t\t\t\t\t\t\t\tng-change=\"updatePrice(item)\"\r\n\t\t\t\t\t\t\t\t\tmin=\"0\" />\r\n\t\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t\t<td style=\"text-align: center\">\r\n\t\t\t\t\t\t\t\t฿\r\n\t\t\t\t\t\t\t\t<label ng-bind=\"item.totalPrice\"></label>\r\n\t\t\t\t\t\t\t</td>\r\n\t\t\t\t\t\t</tr>\r\n\t\t\t\t\t</tbody>\r\n\t\t\t\t</table>\r\n\t\t\t\t<p style=\"text-align: right; padding-right: 18px\">Grand Price: ฿{{c.total_display}}</p>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"modal-footer\">\r\n\t\t\t\t<button class=\"btn btn-primary\" ng-click=\"c.updateCart()\">${Update}</button>\r\n\t\t\t\t<button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Close</button>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n",
            "max_length": 65000,
            "ed": {
                "name": "template"
            }
        },
        "internal": {
            "sys_mandatory": false,
            "visible": true,
            "dbType": -7,
            "label": "Internal",
            "sys_readonly": false,
            "type": "boolean",
            "mandatory": false,
            "displayValue": "false",
            "readonly": false,
            "hint": "",
            "name": "internal",
            "attributes": {},
            "choice": 0,
            "value": "false",
            "max_length": 40,
            "ed": {
                "name": "internal"
            }
        },
        "css": {
            "sys_mandatory": false,
            "visible": true,
            "dbType": -1,
            "label": "CSS",
            "sys_readonly": false,
            "type": "css",
            "mandatory": false,
            "displayValue": ".modal-dialog {\n\twidth: 75%;\n\tmargin: auto auto;\n}\n\n.my-custom-scrollbar {\n\tposition: relative;\n\toverflow-x: scroll;\n\toverflow-y: hidden;\n}\n\n// .table-wrapper-scroll-y {\n// \tdisplay: block;\n// }\n\n.table-paginator {\n\tposition: relative;\n\theight: 75px;\n\t//float: right;\n\tcolor: #646262;\n}\n\n.align-right {\n\tposition: absolute;\n\ttop: 0;\n\tright: 2rem;\n}\n\n.rpp {\n\tdisplay: inline-block;\n\tmargin-right: 4rem;\n}\n\n.rpp h4 {\n\tfont-size: 14px;\n\tdisplay: inline-block;\n\tmargin-right: 2rem;\n}\n\n.page-control {\n\tdisplay: inline-block;\n}\n\n.page-control .current-page {\n\tdisplay: inline-block;\n\tmargin-right: 2rem;\n}\n\n.page-prev {\n\tmargin-right: 2rem;\n}\n\n.page-next {\n\tmargin-left: 2rem;\n}\n\nth {\n\tbackground-color: #f5f5f5;\n}\n\n.form-input-control {\n\theight: 35px;\n\tborder-radius: 5px;\n\tborder: 1px solid;\n}\n\n.form-fixed-control {\n\theight: 35px;\n\twidth: 60px;\n\tborder-radius: 5px;\n\tborder: 1px solid;\n}\n\n.form-photo-control {\n\theight: 35px;\n\twidth: 80px;\n\tborder-radius: 5px;\n\tborder: 1px solid;\n}\n\n.form-extra-control {\n\theight: 35px;\n\twidth: 90px;\n\tborder-radius: 5px;\n\tborder: 1px solid;\n}\n\n.po {\n\twidth: 20px;\n\theight: 20px;\n\tbackground-color: #b2f5ee;\n}\n\n.pr {\n\twidth: 20px;\n\theight: 20px;\n\tbackground-color: #daf7a6;\n}\n\n.column {\n\twidth: 40%;\n}\n\n.column1 {\n\twidth: 75%;\n}\n\n.column2 {\n\tmargin-left: auto;\n}\n\n.row {\n\tmargin-bottom: 20px;\n\tdisplay: flex;\n}\n\n.row .row {\n\tmargin: 0;\n}\n\n.row > * {\n\tpadding: 15px;\n\tflex: 1;\n}\n\n.example1 {\n\tborder: 2px solid #66cc99;\n\tpadding: 5px;\n\tborder-radius: 20px;\n}\n\n.tablecolumn {\n\tbackground-color: #cce6ff;\n}\n",
            "readonly": false,
            "hint": "",
            "name": "css",
            "attributes": {},
            "choice": 0,
            "value": ".modal-dialog {\n\twidth: 75%;\n\tmargin: auto auto;\n}\n\n.my-custom-scrollbar {\n\tposition: relative;\n\toverflow-x: scroll;\n\toverflow-y: hidden;\n}\n\n// .table-wrapper-scroll-y {\n// \tdisplay: block;\n// }\n\n.table-paginator {\n\tposition: relative;\n\theight: 75px;\n\t//float: right;\n\tcolor: #646262;\n}\n\n.align-right {\n\tposition: absolute;\n\ttop: 0;\n\tright: 2rem;\n}\n\n.rpp {\n\tdisplay: inline-block;\n\tmargin-right: 4rem;\n}\n\n.rpp h4 {\n\tfont-size: 14px;\n\tdisplay: inline-block;\n\tmargin-right: 2rem;\n}\n\n.page-control {\n\tdisplay: inline-block;\n}\n\n.page-control .current-page {\n\tdisplay: inline-block;\n\tmargin-right: 2rem;\n}\n\n.page-prev {\n\tmargin-right: 2rem;\n}\n\n.page-next {\n\tmargin-left: 2rem;\n}\n\nth {\n\tbackground-color: #f5f5f5;\n}\n\n.form-input-control {\n\theight: 35px;\n\tborder-radius: 5px;\n\tborder: 1px solid;\n}\n\n.form-fixed-control {\n\theight: 35px;\n\twidth: 60px;\n\tborder-radius: 5px;\n\tborder: 1px solid;\n}\n\n.form-photo-control {\n\theight: 35px;\n\twidth: 80px;\n\tborder-radius: 5px;\n\tborder: 1px solid;\n}\n\n.form-extra-control {\n\theight: 35px;\n\twidth: 90px;\n\tborder-radius: 5px;\n\tborder: 1px solid;\n}\n\n.po {\n\twidth: 20px;\n\theight: 20px;\n\tbackground-color: #b2f5ee;\n}\n\n.pr {\n\twidth: 20px;\n\theight: 20px;\n\tbackground-color: #daf7a6;\n}\n\n.column {\n\twidth: 40%;\n}\n\n.column1 {\n\twidth: 75%;\n}\n\n.column2 {\n\tmargin-left: auto;\n}\n\n.row {\n\tmargin-bottom: 20px;\n\tdisplay: flex;\n}\n\n.row .row {\n\tmargin: 0;\n}\n\n.row > * {\n\tpadding: 15px;\n\tflex: 1;\n}\n\n.example1 {\n\tborder: 2px solid #66cc99;\n\tpadding: 5px;\n\tborder-radius: 20px;\n}\n\n.tablecolumn {\n\tbackground-color: #cce6ff;\n}\n",
            "max_length": 8000,
            "ed": {
                "name": "css"
            }
        },
        "roles": {
            "sys_mandatory": false,
            "visible": true,
            "dbType": 12,
            "label": "Roles",
            "sys_readonly": false,
            "type": "user_roles",
            "mandatory": false,
            "displayValue": "",
            "readonly": false,
            "hint": "",
            "name": "roles",
            "attributes": {
                "no_truncate": "true",
                "update_exempt": "true",
                "record_watcher_blacklist": "true"
            },
            "choice": 0,
            "value": "",
            "max_length": 255,
            "ed": {
                "name": "roles"
            }
        },
        "link": {
            "sys_mandatory": false,
            "visible": true,
            "dbType": -1,
            "label": "Link",
            "sys_readonly": false,
            "type": "script",
            "mandatory": false,
            "displayValue": "function link(scope, element, attrs, controller) { \n\n }",
            "readonly": false,
            "hint": "",
            "name": "link",
            "attributes": {
                "client_script": "true"
            },
            "choice": 0,
            "value": "function link(scope, element, attrs, controller) { \n\n }",
            "max_length": 65000,
            "ed": {
                "name": "link"
            }
        },
        "description": {
            "sys_mandatory": false,
            "visible": true,
            "dbType": -1,
            "label": "Description",
            "sys_readonly": false,
            "type": "string",
            "mandatory": false,
            "displayValue": "",
            "readonly": false,
            "hint": "Defines what the widget does",
            "name": "description",
            "attributes": {
                "edge_encryption_enabled": "true"
            },
            "choice": 0,
            "value": "",
            "max_length": 300,
            "ed": {
                "name": "description"
            }
        },
        "demo_data": {
            "sys_mandatory": false,
            "visible": true,
            "dbType": -1,
            "label": "Demo data",
            "sys_readonly": false,
            "type": "json",
            "mandatory": false,
            "displayValue": "",
            "readonly": false,
            "hint": "",
            "name": "demo_data",
            "attributes": {},
            "choice": 0,
            "value": "",
            "max_length": 8000,
            "ed": {
                "name": "demo_data"
            }
        },
        "option_schema": {
            "sys_mandatory": false,
            "visible": true,
            "dbType": -1,
            "label": "Option schema",
            "sys_readonly": false,
            "type": "json",
            "mandatory": false,
            "displayValue": "",
            "readonly": false,
            "hint": "",
            "name": "option_schema",
            "attributes": {},
            "choice": 0,
            "value": "",
            "max_length": 8000,
            "ed": {
                "name": "option_schema"
            }
        },
        "script": {
            "sys_mandatory": false,
            "visible": true,
            "dbType": -1,
            "label": "Server script",
            "sys_readonly": false,
            "type": "script",
            "mandatory": false,
            "displayValue": "(function () {\r\n\tvar arr = [];\r\n\tconsole.log('input.action : ' + input.action);\r\n\t// First Time Load\r\n\tif (input.action == 'referencevalue' && input.filterData != '') {\r\n\t\tvar userGR = new GlideRecord('sys_user');\r\n\t\tif (userGR.get(input.requested_for)) {\r\n\t\t\tdata.user_dept = userGR.getValue('department'); // sys_id\r\n\t\t}\r\n\r\n\t\t// console.log('data.user_dept : ' + data.user_dept);\r\n\r\n\t\tvar checkItem = new GlideRecord('u_map_master_item_holder');\r\n\r\n\t\tcheckItem.addEncodedQuery(\r\n\t\t\t'u_can_pick_itemDYNAMIC90d1921e5f510100a9ad2572f2b477fe ' +\r\n\t\t\t\t'^ORu_can_pick_item_groupLIKE' +\r\n\t\t\t\tdata.user_dept +\r\n\t\t\t\t'^ORu_groupDYNAMICd6435e965f510100a9ad2572f2b47744',\r\n\t\t);\r\n\t\tcheckItem.query();\r\n\t\t// console.log('checkItem count: ' + checkItem.getEncodedQuery());\r\n\r\n\t\tvar arrAllowed = []; // items allowed for this user\r\n\r\n\t\twhile (checkItem.next()) {\r\n\t\t\tarrAllowed.push(checkItem.u_item.sys_id.toString()); // collect the item field\r\n\t\t}\r\n\r\n\t\t// Deduplicate\r\n\t\tvar arrayUtil = new ArrayUtil();\r\n\t\tvar finalItems = arrayUtil.unique(arrAllowed);\r\n\r\n\t\t// console.log('finalItems : ' + finalItems);\r\n\t\t// console.log('input.budget_holder : ' + input.budget_holder);\r\n\r\n\t\tvar master_item = new GlideRecord('u_istationery_stock_in');\r\n\t\tmaster_item.addQuery('u_master_item_name.sys_id', 'IN', finalItems);\r\n\t\tmaster_item.addQuery('u_budget_holder.u_budget_holder', input.budget_holder);\r\n\t\tmaster_item.addQuery('u_category', input.filterData.category);\r\n\t\tmaster_item.addQuery('u_sub_category', input.filterData.sub_category);\r\n\t\tmaster_item.addQuery('active', true);\r\n\t\tmaster_item.orderBy('name');\r\n\t\tmaster_item.query();\r\n\r\n\t\t// console.log('master_item count: ' + master_item.getEncodedQuery());\r\n\r\n\t\twhile (master_item.next()) {\r\n\t\t\t// console.log('master_item: ' + master_item.getRowCount());\r\n\t\t\tvar img = ' ';\r\n\t\t\tvar picture = master_item.u_master_item_name.u_item_picture.getValue('picture');\r\n\r\n\t\t\tif (\r\n\t\t\t\tmaster_item.u_master_item_name.u_item_picture.getValue('picture') != '' ||\r\n\t\t\t\tmaster_item.u_master_item_name.u_item_picture.getValue('picture') != ' ' ||\r\n\t\t\t\tmaster_item.u_master_item_name.u_item_picture.getValue('picture') != null\r\n\t\t\t) {\r\n\t\t\t\timg = master_item.u_master_item_name.u_item_picture.getValue('picture') + '.iix';\r\n\t\t\t}\r\n\r\n\t\t\tvar caseResult = checkUseCase(master_item);\r\n\r\n\t\t\tvar obj = {\r\n\t\t\t\tphoto1: img,\r\n\t\t\t\tdescription: master_item.u_master_item_name.u_name.getValue('name'),\r\n\t\t\t\tunit_type: master_item.u_stock_in_unit.getDisplayValue(),\r\n\t\t\t\tunit_price: parseFloat(master_item.getValue('u_stock_in_unit_cost'))\r\n\t\t\t\t\t.toFixed(2)\r\n\t\t\t\t\t.toString()\r\n\t\t\t\t\t.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ','),\r\n\t\t\t\tstock_in_unit_cost: parseFloat(master_item.getValue('u_stock_in_unit_cost'))\r\n\t\t\t\t\t.toFixed(2)\r\n\t\t\t\t\t.toString()\r\n\t\t\t\t\t.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ','),\r\n\t\t\t\tqty: 0,\r\n\t\t\t\ttotalPrice: 0.0,\r\n\t\t\t\titem_id: master_item.getUniqueValue(),\r\n\t\t\t\tactive: master_item.active.getDisplayValue(),\r\n\t\t\t\tuc_code: caseResult.ucCode,\r\n\t\t\t\teditable: caseResult.editable,\r\n\t\t\t};\r\n\r\n\t\t\tarr.push(obj);\r\n\t\t}\r\n\r\n\t\tdata.finalObject = arr;\r\n\t}\r\n\t// First Time Load\r\n\telse if (input.action == 'referencepreviewvalue') {\r\n\t\t//gs.log('SIT Case : B');\r\n\t\tarr = [];\r\n\t\tfor (var i = 0; i < input.arrdatavalue.length; i++) {\r\n\t\t\tvar mrvs_id;\r\n\t\t\tvar ms_item = GlideRecord('u_istationery_stock_in');\r\n\t\t\tms_item.addQuery('sys_id', 'IN', input.arrdatavalue[i].u_description_sin);\r\n\t\t\tms_item.query();\r\n\r\n\t\t\twhile (ms_item.next()) {\r\n\t\t\t\tmrvs_id = ms_item.getUniqueValue();\r\n\t\t\t\tvar imgPreview = ' ';\r\n\r\n\t\t\t\tif (\r\n\t\t\t\t\tms_item.u_master_item_name.u_item_picture.getValue('picture') != '' ||\r\n\t\t\t\t\tms_item.u_master_item_name.u_item_picture.getValue('picture') != ' ' ||\r\n\t\t\t\t\tms_item.u_master_item_name.u_item_picture.getValue('picture') != null\r\n\t\t\t\t) {\r\n\t\t\t\t\timgPreview = ms_item.u_master_item_name.u_item_picture.getValue('picture') + '.iix';\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar qty = input.arrdatavalue[i].u_qty.replace(/,/g, '');\r\n\r\n\t\t\t\tvar caseResult = checkUseCase(ms_item);\r\n\r\n\t\t\t\tvar objPreview = {\r\n\t\t\t\t\tphoto1: imgPreview,\r\n\t\t\t\t\t// description: ms_item.getValue('name'),\r\n\t\t\t\t\tdescription: ms_item.u_master_item_name.u_name.getValue('name'),\r\n\t\t\t\t\tunit_type: ms_item.u_stock_in_unit.getDisplayValue(),\r\n\t\t\t\t\tunit_price: parseFloat(ms_item.getValue('u_stock_in_unit_cost'))\r\n\t\t\t\t\t\t.toFixed(2)\r\n\t\t\t\t\t\t.toString()\r\n\t\t\t\t\t\t.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ','),\r\n\t\t\t\t\tstock_in_unit_cost: parseFloat(ms_item.getValue('u_stock_in_unit_cost'))\r\n\t\t\t\t\t\t.toFixed(2)\r\n\t\t\t\t\t\t.toString()\r\n\t\t\t\t\t\t.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ','),\r\n\t\t\t\t\tqty: parseInt(qty),\r\n\t\t\t\t\ttotalPrice: input.arrdatavalue[i].u_total_price,\r\n\t\t\t\t\titem_id: mrvs_id,\r\n\t\t\t\t\tuc_code: caseResult.ucCode,\r\n\t\t\t\t\teditable: caseResult.editable,\r\n\t\t\t\t};\r\n\t\t\t\tarr.push(objPreview);\r\n\t\t\t}\r\n\t\t\tdata.finalPreviewObject = arr;\r\n\t\t\tvar totalAmnt = 0;\r\n\t\t\tfor (var j = 0; j < data.finalPreviewObject.length; j++) {\r\n\t\t\t\ttotalAmnt =\r\n\t\t\t\t\tparseFloat(totalAmnt) +\r\n\t\t\t\t\tparseFloat(data.finalPreviewObject[j].totalPrice.replace(/,/g, ''));\r\n\t\t\t}\r\n\t\t\tdata.grand_price = totalAmnt;\r\n\t\t}\r\n\t} else if (input.action == 'referenceoldvalue' && input.filterData != '') {\r\n\t\tarr = [];\r\n\t\tvar mas_item = GlideRecord('u_istationery_stock_in');\r\n\t\tmas_item.addEncodedQuery(\r\n\t\t\t'u_category=' +\r\n\t\t\t\tinput.filterData.category +\r\n\t\t\t\t'^u_sub_category=' +\r\n\t\t\t\tinput.filterData.sub_category +\r\n\t\t\t\t'^active=true^ORDERBYname',\r\n\t\t);\r\n\t\tmas_item.query();\r\n\r\n\t\twhile (mas_item.next()) {\r\n\t\t\tvar imgs = ' ';\r\n\t\t\tif (\r\n\t\t\t\tmas_item.getValue('picture') != '' ||\r\n\t\t\t\tmas_item.getValue('picture') != ' ' ||\r\n\t\t\t\tmas_item.getValue('picture') != null\r\n\t\t\t) {\r\n\t\t\t\timgs = mas_item.getValue('picture') + '.iix';\r\n\t\t\t}\r\n\r\n\t\t\tvar caseResult = checkUseCase(mas_item);\r\n\r\n\t\t\tvar objOld = {\r\n\t\t\t\tphoto1: imgs,\r\n\t\t\t\tdescription: mas_item.getValue('name'),\r\n\t\t\t\tunit_type: mas_item.u_stock_in_unit.getDisplayValue(),\r\n\t\t\t\tunit_price: parseFloat(mas_item.getValue('u_stock_in_unit_cost'))\r\n\t\t\t\t\t.toFixed(2)\r\n\t\t\t\t\t.toString()\r\n\t\t\t\t\t.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ','),\r\n\t\t\t\tstock_in_unit_cost: parseFloat(mas_item.getValue('u_stock_in_unit_cost'))\r\n\t\t\t\t\t.toFixed(2)\r\n\t\t\t\t\t.toString()\r\n\t\t\t\t\t.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ','),\r\n\t\t\t\tqty: 0,\r\n\t\t\t\ttotalPrice: 0.0,\r\n\t\t\t\titem_id: mas_item.getUniqueValue(),\r\n\t\t\t\tuc_code: caseResult.ucCode,\r\n\t\t\t\teditable: caseResult.editable,\r\n\t\t\t};\r\n\t\t\tfor (var s = 0; s < input.mrvsvalue.length; s++) {\r\n\t\t\t\tif (input.mrvsvalue[s].u_description_sin === objOld.item_id) {\r\n\t\t\t\t\tvar qty = input.mrvsvalue[s].u_qty.replace(/,/g, '');\r\n\t\t\t\t\tobjOld.qty = parseInt(qty);\r\n\t\t\t\t\tobjOld.totalPrice = input.mrvsvalue[s].u_total_price;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tarr.push(objOld);\r\n\t\t}\r\n\t\tdata.finalSubObject = arr;\r\n\t} else if (input.action == 'checkmultirow') {\r\n\t\tvar arrayUtil = new ArrayUtil();\r\n\t\tvar finalmvrs = [];\r\n\t\tvar oldArr = input.oldArr;\r\n\t\tvar newArr = input.newArr;\r\n\r\n\t\tfor (var v = 0; v < newArr.length; v++) {\r\n\t\t\t//check loop\r\n\t\t\tvar foundIndex = -1;\r\n\t\t\tfor (var x = 0; x < oldArr.length; x++) {\r\n\t\t\t\tif (oldArr[x].u_description_sin === newArr[v].u_description_sin) {\r\n\t\t\t\t\tfoundIndex = x;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (foundIndex != -1) {\r\n\t\t\t\t//gs.log('A');\r\n\t\t\t\tif (newArr[v].u_qty != 0) {\r\n\t\t\t\t\t//gs.log('A - A');\r\n\t\t\t\t\toldArr[foundIndex].u_qty = newArr[v].u_qty;\r\n\t\t\t\t\toldArr[foundIndex].u_total_price = newArr[v].u_total_price;\r\n\t\t\t\t} else {\r\n\t\t\t\t\t//gs.log('A - B');\r\n\t\t\t\t\toldArr.splice(foundIndex, 1);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t//gs.log('B');\r\n\t\t\t\tif (foundIndex == -1) {\r\n\t\t\t\t\tif (newArr[v].u_qty != 0) {\r\n\t\t\t\t\t\t//gs.log('B - A');\r\n\t\t\t\t\t\toldArr.push(newArr[v]);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t//gs.log('B - B');\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tdata.oldArr = oldArr;\r\n\t} else if (input.action == 'previewUpdate') {\r\n\t\tvar oldArr = input.oldArr;\r\n\t\tvar newArr = input.newArr;\r\n\r\n\t\tfor (var v = 0; v < newArr.length; v++) {\r\n\t\t\t//check loop\r\n\t\t\tvar indexFound = -1;\r\n\t\t\tfor (var x = 0; x < oldArr.length; x++) {\r\n\t\t\t\tif (oldArr[x].u_description_sin === newArr[v].u_description_sin) {\r\n\t\t\t\t\tindexFound = x;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (indexFound != -1) {\r\n\t\t\t\t//gs.log('A');\r\n\t\t\t\tif (newArr[v].u_qty != 0) {\r\n\t\t\t\t\t//gs.log('A - A');\r\n\t\t\t\t\toldArr[indexFound].u_qty = newArr[v].u_qty;\r\n\t\t\t\t\toldArr[indexFound].u_total_price = newArr[v].u_total_price;\r\n\t\t\t\t} else {\r\n\t\t\t\t\t//gs.log('A - B');\r\n\t\t\t\t\toldArr.splice(indexFound, 1);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t//gs.log('B');\r\n\t\t\t\tif (indexFound == -1) {\r\n\t\t\t\t\tif (newArr[v].u_qty != 0) {\r\n\t\t\t\t\t\t//gs.log('B - A');\r\n\t\t\t\t\t\toldArr.push(newArr[v]);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t//gs.log('B - B');\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tdata.oldArr = oldArr;\r\n\t} else if (input.action == 'determineUcCode') {\r\n\t\tvar itemIds = (input.itemId || '').split(',').map(function (id) {\r\n\t\t\treturn id.trim();\r\n\t\t});\r\n\t\tvar results = [];\r\n\r\n\t\titemIds.forEach(function (id) {\r\n\t\t\t// console.log('ids: ' + id);\r\n\t\t\tvar grItem = new GlideRecord('u_istationery_stock_in');\r\n\t\t\tgrItem.addEncodedQuery('sys_idIN' + id);\r\n\t\t\tgrItem.query();\r\n\t\t\twhile (grItem.next()) {\r\n\t\t\t\tvar result = checkUseCase(grItem);\r\n\t\t\t\tconsole.log('result[checkUseCase] - ' + JSON.stringify(result));\r\n\t\t\t\tresults.push({\r\n\t\t\t\t\tdescription: id,\r\n\t\t\t\t\tname: grItem.getValue('name'),\r\n\t\t\t\t\tuc_code: result.ucCode,\r\n\t\t\t\t\tu_unit_price: result.u_unit_price,\r\n\t\t\t\t\tu_stock_in_unit: grItem.getDisplayValue('u_stock_in_unit'),\r\n\t\t\t\t\toldPrice: result.u_unit_price,\r\n\t\t\t\t\teditable: result.editable,\r\n\t\t\t\t});\r\n\t\t\t\tconsole.log('results - ' + JSON.stringify(results));\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tdata.results = results;\r\n\t}\r\n\r\n\tfunction checkUseCase(grItem) {\r\n\t\tvar ucCode = 'Out of case';\r\n\t\tvar editable = true;\r\n\r\n\t\t// ---------- Query main items ----------\r\n\t\tvar grUISI = new GlideRecord('u_istationery_stock_in');\r\n\t\tgrUISI.addQuery('u_master_item_name.sys_id', grItem.u_master_item_name);\r\n\t\tgrUISI.query();\r\n\r\n\t\tvar items = [];\r\n\t\twhile (grUISI.next()) {\r\n\t\t\titems.push({\r\n\t\t\t\tsys_id: grUISI.getUniqueValue(),\r\n\t\t\t\titemName: grUISI.u_name,\r\n\t\t\t\tcredit_available: parseInt(grUISI.u_credit_avaliable),\r\n\t\t\t\tactive: grUISI.getValue('active') == '1',\r\n\t\t\t\tu_parent_item: grUISI.getValue('u_parent_item'),\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\t// ---------- No items ----------\r\n\t\tif (items.length === 0) return { ucCode: 'Out of case', editable: false };\r\n\r\n\t\t// ---------- UC-005: PO Active ----------\r\n\t\tvar grPO = new GlideRecord('u_ist_look_up_po_item');\r\n\t\tgrPO.addQuery('u_master_item', grItem.getUniqueValue());\r\n\t\tgrPO.addQuery('u_po.u_active', 'true'); // or true if Boolean field\r\n\t\tgrPO.query();\r\n\t\tif (grPO.hasNext()) return { ucCode: 'UC-005', editable: false };\r\n\r\n\t\t// ---------- Determine UC Code ----------\r\n\t\tif (items.length === 1) {\r\n\t\t\tvar item = items[0];\r\n\t\t\tif (item.active) {\r\n\t\t\t\tgs.log(item.itemName + ' : ' + item.credit_available);\r\n\t\t\t\treturn { ucCode: item.credit_available === 0 ? 'UC-001' : 'UC-002', editable: true };\r\n\t\t\t} else {\r\n\t\t\t\treturn { ucCode: 'Out of case', editable: false };\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tvar hasInactiveCreditZero = false;\r\n\t\t\tvar hasInactiveCreditMore = false;\r\n\t\t\tvar allActive = true;\r\n\t\t\tvar outOfcase = false;\r\n\t\t\t// console.log('items - ' + JSON.stringify(items));\r\n\r\n\t\t\tvar checkParentItem = checkParent(items);\r\n\t\t\t// console.log('checkParentItem - ' + JSON.stringify(checkParentItem));\r\n\t\t\tif (checkParentItem.hasParent == true) {\r\n\t\t\t\tif (checkParentItem.countActive > 1) {\r\n\t\t\t\t\t// console.log(it.itemName + ' : ' + checkParentItem.countActive + ' : ');\r\n\t\t\t\t\treturn { ucCode: 'UC-007', editable: false };\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tfor (var i = 0; i < items.length; i++) {\r\n\t\t\t\tvar it = items[i];\r\n\t\t\t\t// if (checkParentItem.countActive > 1) {\r\n\t\t\t\t//     console.log(it.itemName + ' : ' + checkParentItem.countActive + ' : ');\r\n\t\t\t\t// \toutOfcase = true;\r\n\t\t\t\t// }\r\n\r\n\t\t\t\t// if (parseInt(it.credit_available) == 0 && !it.active) {\r\n\t\t\t\t// \tconsole.log('in');\r\n\t\t\t\t// \thasInactiveCreditZero = true;\r\n\t\t\t\t// }\r\n\r\n\t\t\t\tif (it.credit_available == 0) {\r\n\t\t\t\t\t// if (it.active == true) {\r\n\t\t\t\t\thasInactiveCreditZero = true;\r\n\t\t\t\t\t// }\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!it.active && it.credit_available > 0) {\r\n\t\t\t\t\thasInactiveCreditMore = true;\r\n\t\t\t\t}\r\n\t\t\t\tif (!it.active) {\r\n\t\t\t\t\tallActive = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// console.log('outOfcase - ' + outOfcase);\r\n\t\t\tif (hasInactiveCreditZero) return { ucCode: 'UC-003', editable: true };\r\n\t\t\tif (hasInactiveCreditMore) return { ucCode: 'UC-004', editable: true };\r\n\t\t\tif (allActive) return { ucCode: 'UC-007', editable: false };\r\n\t\t}\r\n\t}\r\n\r\n\tfunction checkParent(items) {\r\n\t\tvar parentItems = [];\r\n\t\tvar hasParent = false;\r\n\t\tvar countActive = 0;\r\n\r\n\t\tfor (var i = 0; i < items.length; i++) {\r\n\t\t\tvar it = items[i];\r\n\t\t\tif (it.active === true) {\r\n\t\t\t\tcountActive++;\r\n\t\t\t}\r\n\t\t\tif (it.u_parent_item) {\r\n\t\t\t\tparentItems.push(it.u_parent_item);\r\n\t\t\t\thasParent = true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\thasParent: hasParent,\r\n\t\t\tparentItem: parentItems,\r\n\t\t\tcountActive: countActive,\r\n\t\t};\r\n\t}\r\n})();\r\n",
            "readonly": false,
            "hint": "",
            "name": "script",
            "attributes": {},
            "choice": 0,
            "value": "(function () {\r\n\tvar arr = [];\r\n\tconsole.log('input.action : ' + input.action);\r\n\t// First Time Load\r\n\tif (input.action == 'referencevalue' && input.filterData != '') {\r\n\t\tvar userGR = new GlideRecord('sys_user');\r\n\t\tif (userGR.get(input.requested_for)) {\r\n\t\t\tdata.user_dept = userGR.getValue('department'); // sys_id\r\n\t\t}\r\n\r\n\t\t// console.log('data.user_dept : ' + data.user_dept);\r\n\r\n\t\tvar checkItem = new GlideRecord('u_map_master_item_holder');\r\n\r\n\t\tcheckItem.addEncodedQuery(\r\n\t\t\t'u_can_pick_itemDYNAMIC90d1921e5f510100a9ad2572f2b477fe ' +\r\n\t\t\t\t'^ORu_can_pick_item_groupLIKE' +\r\n\t\t\t\tdata.user_dept +\r\n\t\t\t\t'^ORu_groupDYNAMICd6435e965f510100a9ad2572f2b47744',\r\n\t\t);\r\n\t\tcheckItem.query();\r\n\t\t// console.log('checkItem count: ' + checkItem.getEncodedQuery());\r\n\r\n\t\tvar arrAllowed = []; // items allowed for this user\r\n\r\n\t\twhile (checkItem.next()) {\r\n\t\t\tarrAllowed.push(checkItem.u_item.sys_id.toString()); // collect the item field\r\n\t\t}\r\n\r\n\t\t// Deduplicate\r\n\t\tvar arrayUtil = new ArrayUtil();\r\n\t\tvar finalItems = arrayUtil.unique(arrAllowed);\r\n\r\n\t\t// console.log('finalItems : ' + finalItems);\r\n\t\t// console.log('input.budget_holder : ' + input.budget_holder);\r\n\r\n\t\tvar master_item = new GlideRecord('u_istationery_stock_in');\r\n\t\tmaster_item.addQuery('u_master_item_name.sys_id', 'IN', finalItems);\r\n\t\tmaster_item.addQuery('u_budget_holder.u_budget_holder', input.budget_holder);\r\n\t\tmaster_item.addQuery('u_category', input.filterData.category);\r\n\t\tmaster_item.addQuery('u_sub_category', input.filterData.sub_category);\r\n\t\tmaster_item.addQuery('active', true);\r\n\t\tmaster_item.orderBy('name');\r\n\t\tmaster_item.query();\r\n\r\n\t\t// console.log('master_item count: ' + master_item.getEncodedQuery());\r\n\r\n\t\twhile (master_item.next()) {\r\n\t\t\t// console.log('master_item: ' + master_item.getRowCount());\r\n\t\t\tvar img = ' ';\r\n\t\t\tvar picture = master_item.u_master_item_name.u_item_picture.getValue('picture');\r\n\r\n\t\t\tif (\r\n\t\t\t\tmaster_item.u_master_item_name.u_item_picture.getValue('picture') != '' ||\r\n\t\t\t\tmaster_item.u_master_item_name.u_item_picture.getValue('picture') != ' ' ||\r\n\t\t\t\tmaster_item.u_master_item_name.u_item_picture.getValue('picture') != null\r\n\t\t\t) {\r\n\t\t\t\timg = master_item.u_master_item_name.u_item_picture.getValue('picture') + '.iix';\r\n\t\t\t}\r\n\r\n\t\t\tvar caseResult = checkUseCase(master_item);\r\n\r\n\t\t\tvar obj = {\r\n\t\t\t\tphoto1: img,\r\n\t\t\t\tdescription: master_item.u_master_item_name.u_name.getValue('name'),\r\n\t\t\t\tunit_type: master_item.u_stock_in_unit.getDisplayValue(),\r\n\t\t\t\tunit_price: parseFloat(master_item.getValue('u_stock_in_unit_cost'))\r\n\t\t\t\t\t.toFixed(2)\r\n\t\t\t\t\t.toString()\r\n\t\t\t\t\t.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ','),\r\n\t\t\t\tstock_in_unit_cost: parseFloat(master_item.getValue('u_stock_in_unit_cost'))\r\n\t\t\t\t\t.toFixed(2)\r\n\t\t\t\t\t.toString()\r\n\t\t\t\t\t.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ','),\r\n\t\t\t\tqty: 0,\r\n\t\t\t\ttotalPrice: 0.0,\r\n\t\t\t\titem_id: master_item.getUniqueValue(),\r\n\t\t\t\tactive: master_item.active.getDisplayValue(),\r\n\t\t\t\tuc_code: caseResult.ucCode,\r\n\t\t\t\teditable: caseResult.editable,\r\n\t\t\t};\r\n\r\n\t\t\tarr.push(obj);\r\n\t\t}\r\n\r\n\t\tdata.finalObject = arr;\r\n\t}\r\n\t// First Time Load\r\n\telse if (input.action == 'referencepreviewvalue') {\r\n\t\t//gs.log('SIT Case : B');\r\n\t\tarr = [];\r\n\t\tfor (var i = 0; i < input.arrdatavalue.length; i++) {\r\n\t\t\tvar mrvs_id;\r\n\t\t\tvar ms_item = GlideRecord('u_istationery_stock_in');\r\n\t\t\tms_item.addQuery('sys_id', 'IN', input.arrdatavalue[i].u_description_sin);\r\n\t\t\tms_item.query();\r\n\r\n\t\t\twhile (ms_item.next()) {\r\n\t\t\t\tmrvs_id = ms_item.getUniqueValue();\r\n\t\t\t\tvar imgPreview = ' ';\r\n\r\n\t\t\t\tif (\r\n\t\t\t\t\tms_item.u_master_item_name.u_item_picture.getValue('picture') != '' ||\r\n\t\t\t\t\tms_item.u_master_item_name.u_item_picture.getValue('picture') != ' ' ||\r\n\t\t\t\t\tms_item.u_master_item_name.u_item_picture.getValue('picture') != null\r\n\t\t\t\t) {\r\n\t\t\t\t\timgPreview = ms_item.u_master_item_name.u_item_picture.getValue('picture') + '.iix';\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar qty = input.arrdatavalue[i].u_qty.replace(/,/g, '');\r\n\r\n\t\t\t\tvar caseResult = checkUseCase(ms_item);\r\n\r\n\t\t\t\tvar objPreview = {\r\n\t\t\t\t\tphoto1: imgPreview,\r\n\t\t\t\t\t// description: ms_item.getValue('name'),\r\n\t\t\t\t\tdescription: ms_item.u_master_item_name.u_name.getValue('name'),\r\n\t\t\t\t\tunit_type: ms_item.u_stock_in_unit.getDisplayValue(),\r\n\t\t\t\t\tunit_price: parseFloat(ms_item.getValue('u_stock_in_unit_cost'))\r\n\t\t\t\t\t\t.toFixed(2)\r\n\t\t\t\t\t\t.toString()\r\n\t\t\t\t\t\t.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ','),\r\n\t\t\t\t\tstock_in_unit_cost: parseFloat(ms_item.getValue('u_stock_in_unit_cost'))\r\n\t\t\t\t\t\t.toFixed(2)\r\n\t\t\t\t\t\t.toString()\r\n\t\t\t\t\t\t.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ','),\r\n\t\t\t\t\tqty: parseInt(qty),\r\n\t\t\t\t\ttotalPrice: input.arrdatavalue[i].u_total_price,\r\n\t\t\t\t\titem_id: mrvs_id,\r\n\t\t\t\t\tuc_code: caseResult.ucCode,\r\n\t\t\t\t\teditable: caseResult.editable,\r\n\t\t\t\t};\r\n\t\t\t\tarr.push(objPreview);\r\n\t\t\t}\r\n\t\t\tdata.finalPreviewObject = arr;\r\n\t\t\tvar totalAmnt = 0;\r\n\t\t\tfor (var j = 0; j < data.finalPreviewObject.length; j++) {\r\n\t\t\t\ttotalAmnt =\r\n\t\t\t\t\tparseFloat(totalAmnt) +\r\n\t\t\t\t\tparseFloat(data.finalPreviewObject[j].totalPrice.replace(/,/g, ''));\r\n\t\t\t}\r\n\t\t\tdata.grand_price = totalAmnt;\r\n\t\t}\r\n\t} else if (input.action == 'referenceoldvalue' && input.filterData != '') {\r\n\t\tarr = [];\r\n\t\tvar mas_item = GlideRecord('u_istationery_stock_in');\r\n\t\tmas_item.addEncodedQuery(\r\n\t\t\t'u_category=' +\r\n\t\t\t\tinput.filterData.category +\r\n\t\t\t\t'^u_sub_category=' +\r\n\t\t\t\tinput.filterData.sub_category +\r\n\t\t\t\t'^active=true^ORDERBYname',\r\n\t\t);\r\n\t\tmas_item.query();\r\n\r\n\t\twhile (mas_item.next()) {\r\n\t\t\tvar imgs = ' ';\r\n\t\t\tif (\r\n\t\t\t\tmas_item.getValue('picture') != '' ||\r\n\t\t\t\tmas_item.getValue('picture') != ' ' ||\r\n\t\t\t\tmas_item.getValue('picture') != null\r\n\t\t\t) {\r\n\t\t\t\timgs = mas_item.getValue('picture') + '.iix';\r\n\t\t\t}\r\n\r\n\t\t\tvar caseResult = checkUseCase(mas_item);\r\n\r\n\t\t\tvar objOld = {\r\n\t\t\t\tphoto1: imgs,\r\n\t\t\t\tdescription: mas_item.getValue('name'),\r\n\t\t\t\tunit_type: mas_item.u_stock_in_unit.getDisplayValue(),\r\n\t\t\t\tunit_price: parseFloat(mas_item.getValue('u_stock_in_unit_cost'))\r\n\t\t\t\t\t.toFixed(2)\r\n\t\t\t\t\t.toString()\r\n\t\t\t\t\t.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ','),\r\n\t\t\t\tstock_in_unit_cost: parseFloat(mas_item.getValue('u_stock_in_unit_cost'))\r\n\t\t\t\t\t.toFixed(2)\r\n\t\t\t\t\t.toString()\r\n\t\t\t\t\t.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ','),\r\n\t\t\t\tqty: 0,\r\n\t\t\t\ttotalPrice: 0.0,\r\n\t\t\t\titem_id: mas_item.getUniqueValue(),\r\n\t\t\t\tuc_code: caseResult.ucCode,\r\n\t\t\t\teditable: caseResult.editable,\r\n\t\t\t};\r\n\t\t\tfor (var s = 0; s < input.mrvsvalue.length; s++) {\r\n\t\t\t\tif (input.mrvsvalue[s].u_description_sin === objOld.item_id) {\r\n\t\t\t\t\tvar qty = input.mrvsvalue[s].u_qty.replace(/,/g, '');\r\n\t\t\t\t\tobjOld.qty = parseInt(qty);\r\n\t\t\t\t\tobjOld.totalPrice = input.mrvsvalue[s].u_total_price;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tarr.push(objOld);\r\n\t\t}\r\n\t\tdata.finalSubObject = arr;\r\n\t} else if (input.action == 'checkmultirow') {\r\n\t\tvar arrayUtil = new ArrayUtil();\r\n\t\tvar finalmvrs = [];\r\n\t\tvar oldArr = input.oldArr;\r\n\t\tvar newArr = input.newArr;\r\n\r\n\t\tfor (var v = 0; v < newArr.length; v++) {\r\n\t\t\t//check loop\r\n\t\t\tvar foundIndex = -1;\r\n\t\t\tfor (var x = 0; x < oldArr.length; x++) {\r\n\t\t\t\tif (oldArr[x].u_description_sin === newArr[v].u_description_sin) {\r\n\t\t\t\t\tfoundIndex = x;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (foundIndex != -1) {\r\n\t\t\t\t//gs.log('A');\r\n\t\t\t\tif (newArr[v].u_qty != 0) {\r\n\t\t\t\t\t//gs.log('A - A');\r\n\t\t\t\t\toldArr[foundIndex].u_qty = newArr[v].u_qty;\r\n\t\t\t\t\toldArr[foundIndex].u_total_price = newArr[v].u_total_price;\r\n\t\t\t\t} else {\r\n\t\t\t\t\t//gs.log('A - B');\r\n\t\t\t\t\toldArr.splice(foundIndex, 1);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t//gs.log('B');\r\n\t\t\t\tif (foundIndex == -1) {\r\n\t\t\t\t\tif (newArr[v].u_qty != 0) {\r\n\t\t\t\t\t\t//gs.log('B - A');\r\n\t\t\t\t\t\toldArr.push(newArr[v]);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t//gs.log('B - B');\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tdata.oldArr = oldArr;\r\n\t} else if (input.action == 'previewUpdate') {\r\n\t\tvar oldArr = input.oldArr;\r\n\t\tvar newArr = input.newArr;\r\n\r\n\t\tfor (var v = 0; v < newArr.length; v++) {\r\n\t\t\t//check loop\r\n\t\t\tvar indexFound = -1;\r\n\t\t\tfor (var x = 0; x < oldArr.length; x++) {\r\n\t\t\t\tif (oldArr[x].u_description_sin === newArr[v].u_description_sin) {\r\n\t\t\t\t\tindexFound = x;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (indexFound != -1) {\r\n\t\t\t\t//gs.log('A');\r\n\t\t\t\tif (newArr[v].u_qty != 0) {\r\n\t\t\t\t\t//gs.log('A - A');\r\n\t\t\t\t\toldArr[indexFound].u_qty = newArr[v].u_qty;\r\n\t\t\t\t\toldArr[indexFound].u_total_price = newArr[v].u_total_price;\r\n\t\t\t\t} else {\r\n\t\t\t\t\t//gs.log('A - B');\r\n\t\t\t\t\toldArr.splice(indexFound, 1);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t//gs.log('B');\r\n\t\t\t\tif (indexFound == -1) {\r\n\t\t\t\t\tif (newArr[v].u_qty != 0) {\r\n\t\t\t\t\t\t//gs.log('B - A');\r\n\t\t\t\t\t\toldArr.push(newArr[v]);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t//gs.log('B - B');\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tdata.oldArr = oldArr;\r\n\t} else if (input.action == 'determineUcCode') {\r\n\t\tvar itemIds = (input.itemId || '').split(',').map(function (id) {\r\n\t\t\treturn id.trim();\r\n\t\t});\r\n\t\tvar results = [];\r\n\r\n\t\titemIds.forEach(function (id) {\r\n\t\t\t// console.log('ids: ' + id);\r\n\t\t\tvar grItem = new GlideRecord('u_istationery_stock_in');\r\n\t\t\tgrItem.addEncodedQuery('sys_idIN' + id);\r\n\t\t\tgrItem.query();\r\n\t\t\twhile (grItem.next()) {\r\n\t\t\t\tvar result = checkUseCase(grItem);\r\n\t\t\t\tconsole.log('result[checkUseCase] - ' + JSON.stringify(result));\r\n\t\t\t\tresults.push({\r\n\t\t\t\t\tdescription: id,\r\n\t\t\t\t\tname: grItem.getValue('name'),\r\n\t\t\t\t\tuc_code: result.ucCode,\r\n\t\t\t\t\tu_unit_price: result.u_unit_price,\r\n\t\t\t\t\tu_stock_in_unit: grItem.getDisplayValue('u_stock_in_unit'),\r\n\t\t\t\t\toldPrice: result.u_unit_price,\r\n\t\t\t\t\teditable: result.editable,\r\n\t\t\t\t});\r\n\t\t\t\tconsole.log('results - ' + JSON.stringify(results));\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tdata.results = results;\r\n\t}\r\n\r\n\tfunction checkUseCase(grItem) {\r\n\t\tvar ucCode = 'Out of case';\r\n\t\tvar editable = true;\r\n\r\n\t\t// ---------- Query main items ----------\r\n\t\tvar grUISI = new GlideRecord('u_istationery_stock_in');\r\n\t\tgrUISI.addQuery('u_master_item_name.sys_id', grItem.u_master_item_name);\r\n\t\tgrUISI.query();\r\n\r\n\t\tvar items = [];\r\n\t\twhile (grUISI.next()) {\r\n\t\t\titems.push({\r\n\t\t\t\tsys_id: grUISI.getUniqueValue(),\r\n\t\t\t\titemName: grUISI.u_name,\r\n\t\t\t\tcredit_available: parseInt(grUISI.u_credit_avaliable),\r\n\t\t\t\tactive: grUISI.getValue('active') == '1',\r\n\t\t\t\tu_parent_item: grUISI.getValue('u_parent_item'),\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\t// ---------- No items ----------\r\n\t\tif (items.length === 0) return { ucCode: 'Out of case', editable: false };\r\n\r\n\t\t// ---------- UC-005: PO Active ----------\r\n\t\tvar grPO = new GlideRecord('u_ist_look_up_po_item');\r\n\t\tgrPO.addQuery('u_master_item', grItem.getUniqueValue());\r\n\t\tgrPO.addQuery('u_po.u_active', 'true'); // or true if Boolean field\r\n\t\tgrPO.query();\r\n\t\tif (grPO.hasNext()) return { ucCode: 'UC-005', editable: false };\r\n\r\n\t\t// ---------- Determine UC Code ----------\r\n\t\tif (items.length === 1) {\r\n\t\t\tvar item = items[0];\r\n\t\t\tif (item.active) {\r\n\t\t\t\tgs.log(item.itemName + ' : ' + item.credit_available);\r\n\t\t\t\treturn { ucCode: item.credit_available === 0 ? 'UC-001' : 'UC-002', editable: true };\r\n\t\t\t} else {\r\n\t\t\t\treturn { ucCode: 'Out of case', editable: false };\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tvar hasInactiveCreditZero = false;\r\n\t\t\tvar hasInactiveCreditMore = false;\r\n\t\t\tvar allActive = true;\r\n\t\t\tvar outOfcase = false;\r\n\t\t\t// console.log('items - ' + JSON.stringify(items));\r\n\r\n\t\t\tvar checkParentItem = checkParent(items);\r\n\t\t\t// console.log('checkParentItem - ' + JSON.stringify(checkParentItem));\r\n\t\t\tif (checkParentItem.hasParent == true) {\r\n\t\t\t\tif (checkParentItem.countActive > 1) {\r\n\t\t\t\t\t// console.log(it.itemName + ' : ' + checkParentItem.countActive + ' : ');\r\n\t\t\t\t\treturn { ucCode: 'UC-007', editable: false };\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tfor (var i = 0; i < items.length; i++) {\r\n\t\t\t\tvar it = items[i];\r\n\t\t\t\t// if (checkParentItem.countActive > 1) {\r\n\t\t\t\t//     console.log(it.itemName + ' : ' + checkParentItem.countActive + ' : ');\r\n\t\t\t\t// \toutOfcase = true;\r\n\t\t\t\t// }\r\n\r\n\t\t\t\t// if (parseInt(it.credit_available) == 0 && !it.active) {\r\n\t\t\t\t// \tconsole.log('in');\r\n\t\t\t\t// \thasInactiveCreditZero = true;\r\n\t\t\t\t// }\r\n\r\n\t\t\t\tif (it.credit_available == 0) {\r\n\t\t\t\t\t// if (it.active == true) {\r\n\t\t\t\t\thasInactiveCreditZero = true;\r\n\t\t\t\t\t// }\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!it.active && it.credit_available > 0) {\r\n\t\t\t\t\thasInactiveCreditMore = true;\r\n\t\t\t\t}\r\n\t\t\t\tif (!it.active) {\r\n\t\t\t\t\tallActive = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// console.log('outOfcase - ' + outOfcase);\r\n\t\t\tif (hasInactiveCreditZero) return { ucCode: 'UC-003', editable: true };\r\n\t\t\tif (hasInactiveCreditMore) return { ucCode: 'UC-004', editable: true };\r\n\t\t\tif (allActive) return { ucCode: 'UC-007', editable: false };\r\n\t\t}\r\n\t}\r\n\r\n\tfunction checkParent(items) {\r\n\t\tvar parentItems = [];\r\n\t\tvar hasParent = false;\r\n\t\tvar countActive = 0;\r\n\r\n\t\tfor (var i = 0; i < items.length; i++) {\r\n\t\t\tvar it = items[i];\r\n\t\t\tif (it.active === true) {\r\n\t\t\t\tcountActive++;\r\n\t\t\t}\r\n\t\t\tif (it.u_parent_item) {\r\n\t\t\t\tparentItems.push(it.u_parent_item);\r\n\t\t\t\thasParent = true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\thasParent: hasParent,\r\n\t\t\tparentItem: parentItems,\r\n\t\t\tcountActive: countActive,\r\n\t\t};\r\n\t}\r\n})();\r\n",
            "max_length": 65000,
            "ed": {
                "name": "script"
            }
        },
        "has_preview": {
            "sys_mandatory": false,
            "visible": true,
            "dbType": -7,
            "label": "Has preview",
            "sys_readonly": false,
            "type": "boolean",
            "mandatory": false,
            "displayValue": "true",
            "readonly": false,
            "hint": "Defines whether preview data is available",
            "name": "has_preview",
            "attributes": {},
            "choice": 0,
            "value": "true",
            "max_length": 40,
            "ed": {
                "name": "has_preview"
            }
        },
        "public": {
            "sys_mandatory": false,
            "visible": true,
            "dbType": -7,
            "label": "Public",
            "sys_readonly": false,
            "type": "boolean",
            "mandatory": false,
            "displayValue": "true",
            "readonly": false,
            "hint": "Widget publicly available to unauthenticated users",
            "name": "public",
            "attributes": {
                "update_exempt": "true"
            },
            "choice": 0,
            "value": "true",
            "max_length": 40,
            "ed": {
                "name": "public"
            }
        },
        "docs": {
            "sys_mandatory": false,
            "visible": true,
            "table_attributes": {
                "update_synch": "true",
                "synch_attachments": "true"
            },
            "dbType": 12,
            "label": "Docs",
            "sys_readonly": false,
            "type": "reference",
            "mandatory": false,
            "refTable": "sp_documentation",
            "reference_type": "table",
            "displayValue": "",
            "readonly": false,
            "hint": "",
            "name": "docs",
            "attributes": {
                "encode_utf8": "false"
            },
            "reference_key": "sys_id",
            "readonlyClickthrough": false,
            "choice": 0,
            "value": "",
            "max_length": 32,
            "ed": {
                "reference": "sp_documentation",
                "searchField": "title",
                "defaultOperator": "STARTSWITH",
                "name": "docs"
            }
        },
        "client_script": {
            "sys_mandatory": false,
            "visible": true,
            "dbType": -1,
            "label": "Client controller",
            "sys_readonly": false,
            "type": "script",
            "mandatory": false,
            "displayValue": "api.controller = function ($scope, $rootScope) {\r\n\t//#region Variables\r\n\tvar c = this;\r\n\tc.searchText = '';\r\n\tc.currentPage = 1;\r\n\tc.copyArr = [];\r\n\tc.previewOBJ = [];\r\n\tc.orderedItems = [];\r\n\tc.copyObjectArr = [];\r\n\tc.oldData = [];\r\n\tc.checkObj = [];\r\n\tc.tempData = [];\r\n\tc.newArrData = [];\r\n\t$scope.status = $scope.data.status;\r\n\tc.filterResult = { category: '', sub_category: '' };\r\n\tc.oldResult = null;\r\n\r\n\t//#endregion Variables\r\n\r\n\t//#region Helper Functions\r\n\r\n\tconst parseNumber = (value) => parseFloat((value || 0).toString().replace(/,/g, '')) || 0;\r\n\tconst formatCurrency = (value) =>\r\n\t\tparseNumber(value).toLocaleString('en-US', {\r\n\t\t\tminimumFractionDigits: 2,\r\n\t\t\tmaximumFractionDigits: 2,\r\n\t\t});\r\n\r\n\t//#endregion Helper Functions\r\n\r\n\t//#region updateUCCode Functions\r\n\r\n\t// ===== Update UC Code Table =====\r\n\tc.updateUCCode = function (items) {\r\n\t\t// console.log('items :', items);\r\n\r\n\t\t// ensure items is array\r\n\t\tif (!Array.isArray(items) || items.length === 0) {\r\n\t\t\t$scope.page.g_form.setValue(\r\n\t\t\t\t'u_ticket_summary',\r\n\t\t\t\t'<div style=\"background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px 14px; font-family: Segoe UI, Arial, sans-serif; font-size: 14px; color: #374151; line-height: 1.5; box-shadow: 0 1px 4px rgba(0,0,0,0.05);\">This field is used to store the <strong style=\"color: #2563eb;\">UC Code</strong>, which indicates the system&rsquo;s behavior under different conditions. Use the table below as a quick reference.</div>',\r\n\t\t\t);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// --- ถ้าไม่มี previous state ให้เริ่มต้นใหม่ ---\r\n\t\tif (!c.previousItemsWithDetails) {\r\n\t\t\tc.previousItemsWithDetails = [];\r\n\t\t}\r\n\r\n\t\tc.server\r\n\t\t\t.get({\r\n\t\t\t\taction: 'determineUcCode',\r\n\t\t\t\titemId: items.map((i) => i.u_description_sin).join(','),\r\n\t\t\t})\r\n\t\t\t.then((r) => {\r\n\t\t\t\tconst results = r.data.results || [];\r\n\t\t\t\tconst resultMap = Object.fromEntries(results.map((res) => [res.description, res]));\r\n\r\n\t\t\t\t// --- แปลง previous list เป็น map เพื่อ lookup ง่าย ---\r\n\t\t\t\tconst prevMap = Object.fromEntries(c.previousItemsWithDetails.map((i) => [i.item_id, i]));\r\n\r\n\t\t\t\t// --- map items ใหม่ ---\r\n\t\t\t\tconst itemsWithDetails = items.map((item) => {\r\n\t\t\t\t\tconst res = resultMap[item.u_description_sin] || {};\r\n\t\t\t\t\tconst prev = prevMap[item.description];\r\n\r\n\t\t\t\t\t// --- normalize number ---\r\n\t\t\t\t\tconst prevPrice = parseFloat(String(item.oldPrice || '0').replace(/,/g, ''));\r\n\t\t\t\t\tconst newPrice = parseFloat(String(item.u_unit_price || '0').replace(/,/g, ''));\r\n\r\n\t\t\t\t\tconst flagOldRecord = newPrice !== prevPrice;\r\n\t\t\t\t\tconst oldDisplay = item.oldPrice;\r\n\t\t\t\t\t// const oldDisplay = prev\r\n\t\t\t\t\t// \t? prev.u_unit_price\r\n\t\t\t\t\t// \t: formatCurrency(item.oldPrice || item.u_unit_price);\r\n\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\titem_id: item.description,\r\n\t\t\t\t\t\tdescription: res.name || item.u_description_sin,\r\n\t\t\t\t\t\tuc_code: res.uc_code || '',\r\n\t\t\t\t\t\tu_unit_price: formatCurrency(item.u_unit_price),\r\n\t\t\t\t\t\tu_stock_in_unit: res.u_stock_in_unit,\r\n\t\t\t\t\t\toldPrice: formatCurrency(oldDisplay),\r\n\t\t\t\t\t\tflagOldRecord,\r\n\t\t\t\t\t};\r\n\t\t\t\t});\r\n\r\n\t\t\t\tc.previousItemsWithDetails = itemsWithDetails;\r\n\r\n\t\t\t\t// console.log('itemsWithDetails :', JSON.stringify(itemsWithDetails, null, 2));\r\n\r\n\t\t\t\t// --- render table ---\r\n\t\t\t\tlet htmlValue =\r\n\t\t\t\t\t'<table style=\"width:100%; border-collapse: collapse; font-family: Arial, sans-serif; font-size: 14px;\">' +\r\n\t\t\t\t\t'<thead>' +\r\n\t\t\t\t\t'<tr style=\"background-color: #297bd8; color:#ffffff;\">' +\r\n\t\t\t\t\t'<th style=\"border: 1px solid #ddd; padding: 8px; text-align:center; width:25%;\">Description</th>' +\r\n\t\t\t\t\t'<th style=\"border: 1px solid #ddd; padding: 8px; text-align:center; width:15%;\">Use Case</th>' +\r\n\t\t\t\t\t'<th style=\"border: 1px solid #ddd; padding: 8px; text-align:center; width:20%;\">User Edit Price</th>' +\r\n\t\t\t\t\t'<th style=\"border: 1px solid #ddd; padding: 8px; text-align:center; width:20%;\">Stock-In Unit Cost (Excl. VAT)</th>' +\r\n\t\t\t\t\t'<th style=\"border: 1px solid #ddd; padding: 8px; text-align:center; width:20%;\">Stock-In Unit</th>' +\r\n\t\t\t\t\t'</tr></thead><tbody>';\r\n\r\n\t\t\t\titemsWithDetails.forEach((item) => {\r\n\t\t\t\t\tlet desc = item.description || '';\r\n\t\t\t\t\t// let uc = item.flagOldRecord ? '-' : item.uc_code;\r\n\t\t\t\t\tlet uc = item.flagOldRecord ? item.uc_code : '-';\r\n\t\t\t\t\t// console.log('uc :', uc);\r\n\t\t\t\t\tlet newPrice = item.flagOldRecord ? item.u_unit_price : '-';\r\n\t\t\t\t\t// let newPrice = item.flagOldRecord ? '-' : item.u_unit_price;\r\n\t\t\t\t\t// console.log('newPrice :', newPrice);\r\n\t\t\t\t\tlet oldPrice = item.oldPrice;\r\n\t\t\t\t\t// console.log('oldPrice :', oldPrice);\r\n\r\n\t\t\t\t\t// ถ้า flagOldRecord เป็น true → แถวสีเหลืองอ่อน\r\n\t\t\t\t\tlet rowStyle = item.flagOldRecord ? 'background-color: #fffbe6;' : '';\r\n\r\n\t\t\t\t\thtmlValue +=\r\n\t\t\t\t\t\t`<tr><td style=\"border: 1px solid #ddd; padding: 8px; width:35%;\">` +\r\n\t\t\t\t\t\tdesc +\r\n\t\t\t\t\t\t`</td>` +\r\n\t\t\t\t\t\t`<td style=\"border: 1px solid #ddd; padding: 8px; width:15%; text-align:center\">` +\r\n\t\t\t\t\t\tuc +\r\n\t\t\t\t\t\t`</td>` +\r\n\t\t\t\t\t\t`<td style=\"border: 1px solid #ddd; padding: 8px; width:25%; text-align:center\">` +\r\n\t\t\t\t\t\tnewPrice +\r\n\t\t\t\t\t\t`<td style=\"border: 1px solid #ddd; padding: 8px; width:25%; text-align:center\">` +\r\n\t\t\t\t\t\toldPrice +\r\n\t\t\t\t\t\t`</td>` +\r\n\t\t\t\t\t\t`<td style=\"border: 1px solid #ddd; padding: 8px; width:25%; text-align:center\">` +\r\n\t\t\t\t\t\titem.u_stock_in_unit +\r\n\t\t\t\t\t\t`</td>` +\r\n\t\t\t\t\t\t`</td></tr>`;\r\n\t\t\t\t});\r\n\r\n\t\t\t\thtmlValue += '</tbody></table>';\r\n\r\n\t\t\t\t$scope.page.g_form.setValue('u_ticket_summary', htmlValue);\r\n\t\t\t});\r\n\t};\r\n\r\n\t//#endregion updateUCCode Functions\r\n\r\n\t// ===== Copy Array =====\r\n\tc.copyArray = function () {\r\n\t\tc.filterResult.category = $scope.page.g_form.getValue('u_category');\r\n\t\tc.filterResult.sub_category = $scope.page.g_form.getValue('u_sub_category');\r\n\r\n\t\tif (c.oldResult == null) {\r\n\t\t\tc.oldResult = JSON.parse(JSON.stringify(c.filterResult));\r\n\t\t\tc.fetchValue();\r\n\t\t} else {\r\n\t\t\tif (JSON.stringify(c.oldResult) !== JSON.stringify(c.filterResult)) {\r\n\t\t\t\tc.oldResult = JSON.parse(JSON.stringify(c.filterResult));\r\n\t\t\t\tc.fetchValue();\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\t// ===== Fetch Value =====\r\n\tc.fetchValue = function () {\r\n\t\tconst rawCart = $scope.page.g_form.getValue('istationary_stock_in_item_list_cart');\r\n\t\tconst u_requested_for = $scope.page.g_form.getValue('u_requested_for');\r\n\t\tconst u_budget_holder = $scope.page.g_form.getDisplayValue('u_budget_holder');\r\n\t\tlet reference = rawCart ? 'referenceoldvalue' : 'referencevalue';\r\n\t\tlet checkmvrs = rawCart ? JSON.parse(rawCart) : [];\r\n\t\tc.priceCache = {};\r\n\r\n\t\tconst parseAndRound = (value) =>\r\n\t\t\tMath.round(parseFloat(value?.toString().replace(/,/g, '') || 0) * 100) / 100;\r\n\r\n\t\tc.server\r\n\t\t\t.get({\r\n\t\t\t\taction: reference,\r\n\t\t\t\tfilterData: c.filterResult,\r\n\t\t\t\tpreviewData: c.previewData,\r\n\t\t\t\tmrvsvalue: checkmvrs,\r\n\t\t\t\tbudget_holder: u_budget_holder,\r\n\t\t\t\trequested_for: u_requested_for,\r\n\t\t\t})\r\n\t\t\t.then((r) => {\r\n\t\t\t\tif (!r.data) return;\r\n\t\t\t\tconst finalObject = r.data.finalObject || [];\r\n\t\t\t\tconst finalSubObject = r.data.finalSubObject || [];\r\n\r\n\t\t\t\tif (reference === 'referencevalue') {\r\n\t\t\t\t\tfinalObject.forEach((el) => {\r\n\t\t\t\t\t\tconst price = parseAndRound(el.unit_price);\r\n\t\t\t\t\t\tel.unit_price = price;\r\n\t\t\t\t\t\tel.oldPrice = price; // ✅ เก็บ oldPrice ไว้ตอนแรกเลย\r\n\t\t\t\t\t\tel.uc_code = el.uc_code || '';\r\n\t\t\t\t\t});\r\n\t\t\t\t\tc.copyArr = JSON.parse(JSON.stringify(finalObject));\r\n\t\t\t\t\tc.data.finalObject = finalObject;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst previewMap = Object.fromEntries(finalSubObject.map((item) => [item.item_id, item]));\r\n\r\n\t\t\t\t\tcheckmvrs.forEach((m) => {\r\n\t\t\t\t\t\tconst previewItem = previewMap[m.u_description_sin];\r\n\t\t\t\t\t\tif (previewItem) {\r\n\t\t\t\t\t\t\tconst mrvsPrice = parseAndRound(m.u_unit_price);\r\n\t\t\t\t\t\t\t// ✅ ถ้ามีค่าใน MRVS ให้ใช้ค่านั้นเป็นหลัก\r\n\t\t\t\t\t\t\tif (mrvsPrice && mrvsPrice > 0) {\r\n\t\t\t\t\t\t\t\tpreviewItem.unit_price = mrvsPrice;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tpreviewItem.unit_price = parseAndRound(previewItem.unit_price);\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tpreviewItem.uc_code = m.u_uc_code || previewItem.uc_code || '';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tfinalSubObject.forEach((el) => {\r\n\t\t\t\t\t\tel.unit_price = parseAndRound(el.unit_price);\r\n\t\t\t\t\t\tel.uc_code = el.uc_code || '';\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tc.copyArr = JSON.parse(JSON.stringify(finalSubObject));\r\n\t\t\t\t\tc.data.finalSubObject = finalSubObject;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t};\r\n\r\n\t// ===== Generate Array =====\r\n\tc.generateArray = function () {\r\n\t\tc.finalData = [];\r\n\t\tc.previewData = [];\r\n\t\tc.newArr = [];\r\n\t\tc.olddataArr = [];\r\n\r\n\t\t// Parse oldData\r\n\t\tconst oldDataStr = $scope.page.g_form.getValue('istationary_stock_in_item_list_cart');\r\n\t\tc.oldData = oldDataStr ? JSON.parse(oldDataStr) : [];\r\n\r\n\t\t// Helper: parse number\r\n\t\tconst toNum = (v) => parseFloat((v ?? '0').toString().replace(/,/g, '')) || 0;\r\n\r\n\t\t// ---------- Step 1: Build newArr ----------\r\n\t\tc.copyArr.forEach((item) => {\r\n\t\t\tconst qty = toNum(item.qty);\r\n\t\t\tif (qty > 0) {\r\n\t\t\t\tconst unitPrice = toNum(item.unit_price);\r\n\t\t\t\t// const stock_in_unit_cost = toNum(item.stock_in_unit_cost);\r\n\t\t\t\tc.newArr.push({\r\n\t\t\t\t\tu_description_sin: item.item_id,\r\n\t\t\t\t\tu_unit_type: item.unit_type,\r\n\t\t\t\t\tu_unit_price: unitPrice.toFixed(2),\r\n\t\t\t\t\tstock_in_unit_cost: item.stock_in_unit_cost,\r\n\t\t\t\t\toldPrice: item.oldPrice ? item.oldPrice.toFixed(2) : unitPrice.toFixed(2), // ✅ ใช้ oldPrice จาก referencevalue\r\n\t\t\t\t\tu_qty: qty.toString(),\r\n\t\t\t\t\tu_total_price: (unitPrice * qty).toFixed(2),\r\n\t\t\t\t\tu_uc_code: item.uc_code || '',\r\n\t\t\t\t\tdescription: item.description || '',\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t\t// console.log('**** c.newArr =>: ' + JSON.stringify(c.newArr) + '****');\r\n\r\n\t\t// ---------- Step 2: If oldData exists, sync with newArr ----------\r\n\t\tif (c.oldData && c.oldData.length > 0) {\r\n\t\t\tc.server.get({ action: 'checkmultirow', newArr: c.newArr, oldArr: c.oldData }).then((r) => {\r\n\t\t\t\tconst oldArr = (r.data.oldArr || []).map((item) => ({ ...item }));\r\n\r\n\t\t\t\t// Build index for quick lookup\r\n\t\t\t\tconst newMap = Object.fromEntries(c.newArr.map((n) => [n.u_description_sin, n]));\r\n\r\n\t\t\t\toldArr.forEach((item) => {\r\n\t\t\t\t\tconst match = newMap[item.u_description_sin];\r\n\t\t\t\t\tif (!match) return;\r\n\r\n\t\t\t\t\t// ✅ เก็บราคาเก่าก่อนจะอัปเดต\r\n\t\t\t\t\tif (!item.oldPrice) {\r\n\t\t\t\t\t\titem.oldPrice = toNum(item.u_unit_price).toFixed(2);\r\n\t\t\t\t\t\t// console.log('Set oldPrice for item:', item.oldPrice);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Update qty ถ้าเปลี่ยน\r\n\t\t\t\t\tconst newQty = toNum(match.u_qty);\r\n\t\t\t\t\tif (newQty !== toNum(item.u_qty)) item.u_qty = newQty;\r\n\r\n\t\t\t\t\t// Update unit price ถ้าเปลี่ยน\r\n\t\t\t\t\tconst newPrice = toNum(match.u_unit_price);\r\n\t\t\t\t\tif (newPrice !== toNum(item.u_unit_price)) {\r\n\t\t\t\t\t\titem.u_unit_price = newPrice.toFixed(2);\r\n\t\t\t\t\t\t// ❌ ไม่แตะ oldPrice เพื่อคงค่าเดิมไว้\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Recalculate total price\r\n\t\t\t\t\titem.u_total_price = (toNum(item.u_unit_price) * toNum(item.u_qty)).toFixed(2);\r\n\r\n\t\t\t\t\t// Sync UC code\r\n\t\t\t\t\tif (match.u_uc_code && match.u_uc_code !== item.u_uc_code) {\r\n\t\t\t\t\t\titem.u_uc_code = match.u_uc_code;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Sync description\r\n\t\t\t\t\tif (!item.description) {\r\n\t\t\t\t\t\titem.description = match.description || '';\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\t// Add any new rows from newArr not in oldArr\r\n\t\t\t\tc.newArr.forEach((n) => {\r\n\t\t\t\t\tif (!oldArr.find((i) => i.u_description_sin === n.u_description_sin)) {\r\n\t\t\t\t\t\toldArr.push({ ...n });\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\t// Prepare items for UC code table\r\n\t\t\t\tconst itemsForUC = oldArr.map((item) => {\r\n\t\t\t\t\t// console.log('**** oldArr =>: ' + JSON.stringify(item) + '****');\r\n\t\t\t\t\tconst copyItem = c.copyArr.find((ci) => ci.item_id === item.u_description_sin);\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\tu_description_sin: item.u_description_sin,\r\n\t\t\t\t\t\tdescription: item.description,\r\n\t\t\t\t\t\tu_unit_price: item.u_unit_price,\r\n\t\t\t\t\t\tu_unit_price: item.stock_in_unit_cost,\r\n\t\t\t\t\t\toldPrice: item.oldPrice || item.u_unit_price, // ✅ ใช้ราคาเดิมถ้ามี\r\n\t\t\t\t\t\tu_uc_code: item.u_uc_code || '',\r\n\t\t\t\t\t};\r\n\t\t\t\t});\r\n\r\n\t\t\t\tc.updateUCCode(itemsForUC);\r\n\r\n\t\t\t\t// Update final data & MRV\r\n\t\t\t\tc.olddataArr = oldArr;\r\n\t\t\t\tc.newDataArr = oldArr;\r\n\t\t\t\tc.finalData = oldArr;\r\n\t\t\t\tc.updatMRV(c.newDataArr);\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\t// ---------- First time case ----------\r\n\t\t\tc.olddataArr = c.newArr;\r\n\t\t\tc.newDataArr = c.newArr;\r\n\t\t\tc.finalData = c.newArr;\r\n\r\n\t\t\tconst itemsForUC = c.newArr.map((item) => {\r\n\t\t\t\tconst copyItem = c.copyArr.find((ci) => ci.item_id === item.u_description_sin);\r\n\r\n\t\t\t\treturn {\r\n\t\t\t\t\tu_description_sin: item.u_description_sin,\r\n\t\t\t\t\tdescription: copyItem ? copyItem.description : item.description || item.u_description_sin,\r\n\t\t\t\t\tu_unit_price: item.u_unit_price,\r\n\t\t\t\t\tstock_in_unit_cost: item.stock_in_unit_cost,\r\n\t\t\t\t\toldPrice: item.oldPrice || copyItem?.oldPrice || '',\r\n\t\t\t\t\tuc_code: copyItem ? copyItem.uc_code || '' : item.u_uc_code || '',\r\n\t\t\t\t};\r\n\t\t\t});\r\n\r\n\t\t\t// console.log('✅ itemsForUC (from backend oldPrice):', JSON.stringify(itemsForUC, null, 2));\r\n\r\n\t\t\tc.updateUCCode(itemsForUC);\r\n\t\t\tc.updatMRV(c.newDataArr);\r\n\t\t}\r\n\t};\r\n\r\n\t// ===== Update MRV =====\r\n\tc.updatMRV = function (finalData) {\r\n\t\tc.total = 0;\r\n\r\n\t\tfor (var v = 0; v < finalData.length; v++) {\r\n\t\t\tlet item = finalData[v];\r\n\r\n\t\t\t// แปลง qty และ unit_price เป็นตัวเลข\r\n\t\t\tlet qty = parseFloat(item.u_qty) || 0;\r\n\t\t\tlet unitPrice = parseFloat(item.u_unit_price.toString().replace(/,/g, '')) || 0;\r\n\r\n\t\t\tif (qty > 0) {\r\n\t\t\t\t// คำนวณ total ใหม่\r\n\t\t\t\tlet totalPrice = qty * unitPrice;\r\n\r\n\t\t\t\t// เก็บราคาที่ format แล้ว\r\n\t\t\t\titem.u_unit_price = formatCurrency(unitPrice);\r\n\t\t\t\titem.u_total_price = formatCurrency(totalPrice);\r\n\r\n\t\t\t\t// รวม total ทั้งหมด\r\n\t\t\t\tc.total += totalPrice;\r\n\t\t\t} else {\r\n\t\t\t\t// กรณี qty = 0, กำหนดราคาเป็น 0\r\n\t\t\t\titem.u_unit_price = formatCurrency(0);\r\n\t\t\t\titem.u_total_price = formatCurrency(0);\r\n\t\t\t}\r\n\r\n\t\t\t// console.log('finalData : ' + JSON.stringify(item));\r\n\t\t}\r\n\r\n\t\tc.total_display = c.total.toFixed(2).replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',');\r\n\t\t$scope.page.g_form.setValue('u_grand_price_display', '฿' + c.total_display);\r\n\t\t$scope.page.g_form.setValue('u_grand_price', c.total);\r\n\r\n\t\t$('#myModal').modal('hide');\r\n\t\t$('#myPreviewModal').modal('hide');\r\n\r\n\t\tif (finalData.length !== 0) {\r\n\t\t\t$scope.page.g_form.setValue('istationary_stock_in_item_list_cart', JSON.stringify(finalData));\r\n\t\t\tc.data.finalObject = c.copyArr;\r\n\t\t} else {\r\n\t\t\t$scope.page.g_form.setValue('istationary_stock_in_item_list_cart', '');\r\n\t\t}\r\n\t};\r\n\r\n\t// ===== FETCH OBJECT VALUE FOR PREVIEW =====\r\n\tc.fetchObjectValue = function () {\r\n\t\tconst rawMrvs = $scope.page.g_form.getValue('istationary_stock_in_item_list_cart');\r\n\t\tconst mrvs = rawMrvs ? JSON.parse(rawMrvs) : [];\r\n\r\n\t\tconsole.log('Fetching object value for preview:', mrvs);\r\n\r\n\t\tc.server.get({ action: 'referencepreviewvalue', arrdatavalue: mrvs }).then((response) => {\r\n\t\t\tconst data = response.data;\r\n\t\t\tif (!data) return;\r\n\r\n\t\t\tconst finalPreview = data.finalPreviewObject || [];\r\n\t\t\tconst previewMap = Object.fromEntries(finalPreview.map((p) => [p.item_id, p]));\r\n\t\t\t// console.log('previewMap :', previewMap);\r\n\r\n\t\t\tmrvs.forEach((m) => {\r\n\t\t\t\tm.u_unit_price = parseNumber(m.u_unit_price || 0);\r\n\t\t\t\tm.u_total_price = parseNumber(m.u_total_price || 0);\r\n\t\t\t\tm.u_qty = parseNumber(m.u_qty || 0);\r\n\t\t\t\tm.stock_in_unit_cost = formatCurrency(m.stock_in_unit_cost);\r\n\t\t\t\tm.u_unit_price_display = m.u_unit_price;\r\n\t\t\t\t// m.u_total_price_display = formatCurrency(m.u_total_price);\r\n\r\n\t\t\t\tconst previewItem = previewMap[m.u_description_sin];\r\n\t\t\t\tif (previewItem) {\r\n\t\t\t\t\tpreviewItem.unit_price = parseNumber(previewItem.unit_price || 0);\r\n\r\n\t\t\t\t\tif (m.u_unit_price !== previewItem.unit_price) {\r\n\t\t\t\t\t\tpreviewItem.unit_price = m.u_unit_price;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tpreviewItem.uc_code = m.u_uc_code || previewItem.uc_code || '';\r\n\t\t\t\t}\r\n\t\t\t\t// console.log(' previewItem.unit_price :', previewItem.unit_price);\r\n\t\t\t});\r\n\r\n\t\t\t// Ensure number\r\n\t\t\tfinalPreview.forEach((p) => {\r\n\t\t\t\tp.unit_price = parseNumber(p.unit_price || 0);\r\n\t\t\t\tp.total_price = parseNumber(p.total_price || 0);\r\n\t\t\t\tp.qty = parseNumber(p.qty || 0);\r\n\t\t\t\tp.stock_in_unit_cost = formatCurrency(p.stock_in_unit_cost);\r\n\t\t\t});\r\n\r\n\t\t\tc.data.finalPreviewObject = finalPreview;\r\n\t\t\tc.copyObjectArr = JSON.parse(JSON.stringify(finalPreview));\r\n\t\t\tc.previewOBJ = c.copyObjectArr;\r\n\r\n\t\t\tconst totalNumber = parseNumber(data.grand_price);\r\n\t\t\t// console.log('totalNumber :', totalNumber);\r\n\r\n\t\t\tconst totalDisplay = formatCurrency(data.grand_price);\r\n\t\t\t// console.log('totalDisplay :', totalDisplay);\r\n\r\n\t\t\tc.total_display = totalDisplay;\r\n\t\t\t$scope.page.g_form.setValue('u_grand_price', totalNumber);\r\n\t\t\t$scope.page.g_form.setValue('u_grand_price_display', '฿' + totalDisplay);\r\n\t\t});\r\n\t};\r\n\r\n\t$scope.showLargeImage = function (imgUrl) {\r\n\t\tvar html = '<div align=\"center\">';\r\n\t\tif (imgUrl == '') {\r\n\t\t\thtml += '<img ng-src=\"No%20Image.png\" height=\"500\" />';\r\n\t\t} else {\r\n\t\t\thtml +=\r\n\t\t\t\t'<img ng-src=\"' +\r\n\t\t\t\timgUrl +\r\n\t\t\t\t'\" height=\"500\" onclick=\"window.open(' +\r\n\t\t\t\timgUrl +\r\n\t\t\t\t', _blank);\"/>';\r\n\t\t}\r\n\t\thtml += '</div>';\r\n\t\tc.largeImage = $uibModal\r\n\t\t\t.open({\r\n\t\t\t\ttemplate: html,\r\n\t\t\t})\r\n\t\t\t.then(function () {});\r\n\t};\r\n\r\n\t// ===== UPDATE PRICE FROM INPUT =====\r\n\t$scope.updatePrice = function (item) {\r\n\t\t// console.log('Updating price for item:', item);\r\n\t\tconst parseNumber = (value) => parseFloat((value || '0').toString().replace(/,/g, '')) || 0;\r\n\t\tconst formatNumber = (value) =>\r\n\t\t\tparseFloat(value)\r\n\t\t\t\t.toFixed(2)\r\n\t\t\t\t.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',');\r\n\r\n\t\tconst unitPrice = parseNumber(item.unit_price);\r\n\t\tconst quantity = parseNumber(item.qty);\r\n\t\tconst previousTotal = parseNumber(item.totalPrice);\r\n\t\tconst currentTotalDisplay = parseNumber(c.total_display);\r\n\r\n\t\t// Subtract the old total price of the item from the current total display\r\n\t\tlet newTotalDisplay = currentTotalDisplay - previousTotal;\r\n\r\n\t\t// Calculate new item total price\r\n\t\tlet newItemTotal = 0;\r\n\t\tif (quantity > 0 && unitPrice > 0) {\r\n\t\t\tnewItemTotal = quantity * unitPrice;\r\n\t\t\titem.totalPrice = formatNumber(newItemTotal);\r\n\t\t\tnewTotalDisplay += newItemTotal;\r\n\t\t} else {\r\n\t\t\titem.totalPrice = formatNumber(0);\r\n\t\t}\r\n\r\n\t\t// Update the display total\r\n\t\tc.total_display = formatNumber(newTotalDisplay);\r\n\t};\r\n\r\n\t// ===== UPDATE CART =====\r\n\tc.updateCart = function () {\r\n\t\tc.finalData = [];\r\n\t\tc.previewData = [];\r\n\t\tc.newArr = [];\r\n\t\tc.olddataArr = [];\r\n\r\n\t\t// Get old cart data\r\n\t\tvar oldDataStr = $scope.page.g_form.getValue('istationary_stock_in_item_list_cart');\r\n\t\tc.oldData = JSON.parse(oldDataStr);\r\n\r\n\t\t// Build newArr from previewOBJ\r\n\t\tfor (var y = 0; y < c.previewOBJ.length; y++) {\r\n\t\t\tvar newData = {\r\n\t\t\t\tu_description_sin: c.previewOBJ[y].item_id,\r\n\t\t\t\tu_unit_type: c.previewOBJ[y].unit_type,\r\n\t\t\t\tu_unit_price: c.previewOBJ[y].unit_price,\r\n\t\t\t\tstock_in_unit_cost: c.previewOBJ[y].stock_in_unit_cost,\r\n\t\t\t\tu_qty: c.previewOBJ[y].qty.toString(),\r\n\t\t\t\tu_total_price: c.previewOBJ[y].totalPrice,\r\n\t\t\t};\r\n\t\t\tc.newArr.push(newData);\r\n\t\t}\r\n\r\n\t\t// Call server previewUpdate\r\n\t\tc.server\r\n\t\t\t.get({\r\n\t\t\t\taction: 'previewUpdate',\r\n\t\t\t\tnewArr: c.newArr,\r\n\t\t\t\toldArr: c.oldData,\r\n\t\t\t})\r\n\t\t\t.then(function (r) {\r\n\t\t\t\tconst oldArr = (r.data.oldArr || []).map((oldItem) => {\r\n\t\t\t\t\tconst match = c.previewOBJ.find((p) => p.item_id === oldItem.u_description_sin);\r\n\r\n\t\t\t\t\t// Convert string to number before comparing\r\n\t\t\t\t\tconst oldPriceNum = parseNumber(oldItem.u_unit_price);\r\n\t\t\t\t\tconst newPriceNum = match ? parseNumber(match.unit_price) : oldPriceNum;\r\n\r\n\t\t\t\t\tif (oldPriceNum !== newPriceNum) {\r\n\t\t\t\t\t\treturn { ...oldItem, u_unit_price: formatCurrency(newPriceNum) };\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn { ...oldItem, u_unit_price: formatCurrency(oldItem.u_unit_price) };\r\n\t\t\t\t});\r\n\r\n\t\t\t\t// Save the processed array\r\n\t\t\t\tc.olddataArr = oldArr;\r\n\t\t\t\tc.newDataArr = c.olddataArr;\r\n\r\n\t\t\t\t// Call functions to update UC Code and MRV\r\n\t\t\t\tc.updateUCCode(c.newDataArr);\r\n\t\t\t\tc.updatMRV(c.newDataArr);\r\n\t\t\t});\r\n\t};\r\n};\r\n",
            "readonly": false,
            "hint": "",
            "name": "client_script",
            "attributes": {
                "client_script": "true"
            },
            "choice": 0,
            "value": "api.controller = function ($scope, $rootScope) {\r\n\t//#region Variables\r\n\tvar c = this;\r\n\tc.searchText = '';\r\n\tc.currentPage = 1;\r\n\tc.copyArr = [];\r\n\tc.previewOBJ = [];\r\n\tc.orderedItems = [];\r\n\tc.copyObjectArr = [];\r\n\tc.oldData = [];\r\n\tc.checkObj = [];\r\n\tc.tempData = [];\r\n\tc.newArrData = [];\r\n\t$scope.status = $scope.data.status;\r\n\tc.filterResult = { category: '', sub_category: '' };\r\n\tc.oldResult = null;\r\n\r\n\t//#endregion Variables\r\n\r\n\t//#region Helper Functions\r\n\r\n\tconst parseNumber = (value) => parseFloat((value || 0).toString().replace(/,/g, '')) || 0;\r\n\tconst formatCurrency = (value) =>\r\n\t\tparseNumber(value).toLocaleString('en-US', {\r\n\t\t\tminimumFractionDigits: 2,\r\n\t\t\tmaximumFractionDigits: 2,\r\n\t\t});\r\n\r\n\t//#endregion Helper Functions\r\n\r\n\t//#region updateUCCode Functions\r\n\r\n\t// ===== Update UC Code Table =====\r\n\tc.updateUCCode = function (items) {\r\n\t\t// console.log('items :', items);\r\n\r\n\t\t// ensure items is array\r\n\t\tif (!Array.isArray(items) || items.length === 0) {\r\n\t\t\t$scope.page.g_form.setValue(\r\n\t\t\t\t'u_ticket_summary',\r\n\t\t\t\t'<div style=\"background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px 14px; font-family: Segoe UI, Arial, sans-serif; font-size: 14px; color: #374151; line-height: 1.5; box-shadow: 0 1px 4px rgba(0,0,0,0.05);\">This field is used to store the <strong style=\"color: #2563eb;\">UC Code</strong>, which indicates the system&rsquo;s behavior under different conditions. Use the table below as a quick reference.</div>',\r\n\t\t\t);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// --- ถ้าไม่มี previous state ให้เริ่มต้นใหม่ ---\r\n\t\tif (!c.previousItemsWithDetails) {\r\n\t\t\tc.previousItemsWithDetails = [];\r\n\t\t}\r\n\r\n\t\tc.server\r\n\t\t\t.get({\r\n\t\t\t\taction: 'determineUcCode',\r\n\t\t\t\titemId: items.map((i) => i.u_description_sin).join(','),\r\n\t\t\t})\r\n\t\t\t.then((r) => {\r\n\t\t\t\tconst results = r.data.results || [];\r\n\t\t\t\tconst resultMap = Object.fromEntries(results.map((res) => [res.description, res]));\r\n\r\n\t\t\t\t// --- แปลง previous list เป็น map เพื่อ lookup ง่าย ---\r\n\t\t\t\tconst prevMap = Object.fromEntries(c.previousItemsWithDetails.map((i) => [i.item_id, i]));\r\n\r\n\t\t\t\t// --- map items ใหม่ ---\r\n\t\t\t\tconst itemsWithDetails = items.map((item) => {\r\n\t\t\t\t\tconst res = resultMap[item.u_description_sin] || {};\r\n\t\t\t\t\tconst prev = prevMap[item.description];\r\n\r\n\t\t\t\t\t// --- normalize number ---\r\n\t\t\t\t\tconst prevPrice = parseFloat(String(item.oldPrice || '0').replace(/,/g, ''));\r\n\t\t\t\t\tconst newPrice = parseFloat(String(item.u_unit_price || '0').replace(/,/g, ''));\r\n\r\n\t\t\t\t\tconst flagOldRecord = newPrice !== prevPrice;\r\n\t\t\t\t\tconst oldDisplay = item.oldPrice;\r\n\t\t\t\t\t// const oldDisplay = prev\r\n\t\t\t\t\t// \t? prev.u_unit_price\r\n\t\t\t\t\t// \t: formatCurrency(item.oldPrice || item.u_unit_price);\r\n\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\titem_id: item.description,\r\n\t\t\t\t\t\tdescription: res.name || item.u_description_sin,\r\n\t\t\t\t\t\tuc_code: res.uc_code || '',\r\n\t\t\t\t\t\tu_unit_price: formatCurrency(item.u_unit_price),\r\n\t\t\t\t\t\tu_stock_in_unit: res.u_stock_in_unit,\r\n\t\t\t\t\t\toldPrice: formatCurrency(oldDisplay),\r\n\t\t\t\t\t\tflagOldRecord,\r\n\t\t\t\t\t};\r\n\t\t\t\t});\r\n\r\n\t\t\t\tc.previousItemsWithDetails = itemsWithDetails;\r\n\r\n\t\t\t\t// console.log('itemsWithDetails :', JSON.stringify(itemsWithDetails, null, 2));\r\n\r\n\t\t\t\t// --- render table ---\r\n\t\t\t\tlet htmlValue =\r\n\t\t\t\t\t'<table style=\"width:100%; border-collapse: collapse; font-family: Arial, sans-serif; font-size: 14px;\">' +\r\n\t\t\t\t\t'<thead>' +\r\n\t\t\t\t\t'<tr style=\"background-color: #297bd8; color:#ffffff;\">' +\r\n\t\t\t\t\t'<th style=\"border: 1px solid #ddd; padding: 8px; text-align:center; width:25%;\">Description</th>' +\r\n\t\t\t\t\t'<th style=\"border: 1px solid #ddd; padding: 8px; text-align:center; width:15%;\">Use Case</th>' +\r\n\t\t\t\t\t'<th style=\"border: 1px solid #ddd; padding: 8px; text-align:center; width:20%;\">User Edit Price</th>' +\r\n\t\t\t\t\t'<th style=\"border: 1px solid #ddd; padding: 8px; text-align:center; width:20%;\">Stock-In Unit Cost (Excl. VAT)</th>' +\r\n\t\t\t\t\t'<th style=\"border: 1px solid #ddd; padding: 8px; text-align:center; width:20%;\">Stock-In Unit</th>' +\r\n\t\t\t\t\t'</tr></thead><tbody>';\r\n\r\n\t\t\t\titemsWithDetails.forEach((item) => {\r\n\t\t\t\t\tlet desc = item.description || '';\r\n\t\t\t\t\t// let uc = item.flagOldRecord ? '-' : item.uc_code;\r\n\t\t\t\t\tlet uc = item.flagOldRecord ? item.uc_code : '-';\r\n\t\t\t\t\t// console.log('uc :', uc);\r\n\t\t\t\t\tlet newPrice = item.flagOldRecord ? item.u_unit_price : '-';\r\n\t\t\t\t\t// let newPrice = item.flagOldRecord ? '-' : item.u_unit_price;\r\n\t\t\t\t\t// console.log('newPrice :', newPrice);\r\n\t\t\t\t\tlet oldPrice = item.oldPrice;\r\n\t\t\t\t\t// console.log('oldPrice :', oldPrice);\r\n\r\n\t\t\t\t\t// ถ้า flagOldRecord เป็น true → แถวสีเหลืองอ่อน\r\n\t\t\t\t\tlet rowStyle = item.flagOldRecord ? 'background-color: #fffbe6;' : '';\r\n\r\n\t\t\t\t\thtmlValue +=\r\n\t\t\t\t\t\t`<tr><td style=\"border: 1px solid #ddd; padding: 8px; width:35%;\">` +\r\n\t\t\t\t\t\tdesc +\r\n\t\t\t\t\t\t`</td>` +\r\n\t\t\t\t\t\t`<td style=\"border: 1px solid #ddd; padding: 8px; width:15%; text-align:center\">` +\r\n\t\t\t\t\t\tuc +\r\n\t\t\t\t\t\t`</td>` +\r\n\t\t\t\t\t\t`<td style=\"border: 1px solid #ddd; padding: 8px; width:25%; text-align:center\">` +\r\n\t\t\t\t\t\tnewPrice +\r\n\t\t\t\t\t\t`<td style=\"border: 1px solid #ddd; padding: 8px; width:25%; text-align:center\">` +\r\n\t\t\t\t\t\toldPrice +\r\n\t\t\t\t\t\t`</td>` +\r\n\t\t\t\t\t\t`<td style=\"border: 1px solid #ddd; padding: 8px; width:25%; text-align:center\">` +\r\n\t\t\t\t\t\titem.u_stock_in_unit +\r\n\t\t\t\t\t\t`</td>` +\r\n\t\t\t\t\t\t`</td></tr>`;\r\n\t\t\t\t});\r\n\r\n\t\t\t\thtmlValue += '</tbody></table>';\r\n\r\n\t\t\t\t$scope.page.g_form.setValue('u_ticket_summary', htmlValue);\r\n\t\t\t});\r\n\t};\r\n\r\n\t//#endregion updateUCCode Functions\r\n\r\n\t// ===== Copy Array =====\r\n\tc.copyArray = function () {\r\n\t\tc.filterResult.category = $scope.page.g_form.getValue('u_category');\r\n\t\tc.filterResult.sub_category = $scope.page.g_form.getValue('u_sub_category');\r\n\r\n\t\tif (c.oldResult == null) {\r\n\t\t\tc.oldResult = JSON.parse(JSON.stringify(c.filterResult));\r\n\t\t\tc.fetchValue();\r\n\t\t} else {\r\n\t\t\tif (JSON.stringify(c.oldResult) !== JSON.stringify(c.filterResult)) {\r\n\t\t\t\tc.oldResult = JSON.parse(JSON.stringify(c.filterResult));\r\n\t\t\t\tc.fetchValue();\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\t// ===== Fetch Value =====\r\n\tc.fetchValue = function () {\r\n\t\tconst rawCart = $scope.page.g_form.getValue('istationary_stock_in_item_list_cart');\r\n\t\tconst u_requested_for = $scope.page.g_form.getValue('u_requested_for');\r\n\t\tconst u_budget_holder = $scope.page.g_form.getDisplayValue('u_budget_holder');\r\n\t\tlet reference = rawCart ? 'referenceoldvalue' : 'referencevalue';\r\n\t\tlet checkmvrs = rawCart ? JSON.parse(rawCart) : [];\r\n\t\tc.priceCache = {};\r\n\r\n\t\tconst parseAndRound = (value) =>\r\n\t\t\tMath.round(parseFloat(value?.toString().replace(/,/g, '') || 0) * 100) / 100;\r\n\r\n\t\tc.server\r\n\t\t\t.get({\r\n\t\t\t\taction: reference,\r\n\t\t\t\tfilterData: c.filterResult,\r\n\t\t\t\tpreviewData: c.previewData,\r\n\t\t\t\tmrvsvalue: checkmvrs,\r\n\t\t\t\tbudget_holder: u_budget_holder,\r\n\t\t\t\trequested_for: u_requested_for,\r\n\t\t\t})\r\n\t\t\t.then((r) => {\r\n\t\t\t\tif (!r.data) return;\r\n\t\t\t\tconst finalObject = r.data.finalObject || [];\r\n\t\t\t\tconst finalSubObject = r.data.finalSubObject || [];\r\n\r\n\t\t\t\tif (reference === 'referencevalue') {\r\n\t\t\t\t\tfinalObject.forEach((el) => {\r\n\t\t\t\t\t\tconst price = parseAndRound(el.unit_price);\r\n\t\t\t\t\t\tel.unit_price = price;\r\n\t\t\t\t\t\tel.oldPrice = price; // ✅ เก็บ oldPrice ไว้ตอนแรกเลย\r\n\t\t\t\t\t\tel.uc_code = el.uc_code || '';\r\n\t\t\t\t\t});\r\n\t\t\t\t\tc.copyArr = JSON.parse(JSON.stringify(finalObject));\r\n\t\t\t\t\tc.data.finalObject = finalObject;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst previewMap = Object.fromEntries(finalSubObject.map((item) => [item.item_id, item]));\r\n\r\n\t\t\t\t\tcheckmvrs.forEach((m) => {\r\n\t\t\t\t\t\tconst previewItem = previewMap[m.u_description_sin];\r\n\t\t\t\t\t\tif (previewItem) {\r\n\t\t\t\t\t\t\tconst mrvsPrice = parseAndRound(m.u_unit_price);\r\n\t\t\t\t\t\t\t// ✅ ถ้ามีค่าใน MRVS ให้ใช้ค่านั้นเป็นหลัก\r\n\t\t\t\t\t\t\tif (mrvsPrice && mrvsPrice > 0) {\r\n\t\t\t\t\t\t\t\tpreviewItem.unit_price = mrvsPrice;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tpreviewItem.unit_price = parseAndRound(previewItem.unit_price);\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tpreviewItem.uc_code = m.u_uc_code || previewItem.uc_code || '';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tfinalSubObject.forEach((el) => {\r\n\t\t\t\t\t\tel.unit_price = parseAndRound(el.unit_price);\r\n\t\t\t\t\t\tel.uc_code = el.uc_code || '';\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tc.copyArr = JSON.parse(JSON.stringify(finalSubObject));\r\n\t\t\t\t\tc.data.finalSubObject = finalSubObject;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t};\r\n\r\n\t// ===== Generate Array =====\r\n\tc.generateArray = function () {\r\n\t\tc.finalData = [];\r\n\t\tc.previewData = [];\r\n\t\tc.newArr = [];\r\n\t\tc.olddataArr = [];\r\n\r\n\t\t// Parse oldData\r\n\t\tconst oldDataStr = $scope.page.g_form.getValue('istationary_stock_in_item_list_cart');\r\n\t\tc.oldData = oldDataStr ? JSON.parse(oldDataStr) : [];\r\n\r\n\t\t// Helper: parse number\r\n\t\tconst toNum = (v) => parseFloat((v ?? '0').toString().replace(/,/g, '')) || 0;\r\n\r\n\t\t// ---------- Step 1: Build newArr ----------\r\n\t\tc.copyArr.forEach((item) => {\r\n\t\t\tconst qty = toNum(item.qty);\r\n\t\t\tif (qty > 0) {\r\n\t\t\t\tconst unitPrice = toNum(item.unit_price);\r\n\t\t\t\t// const stock_in_unit_cost = toNum(item.stock_in_unit_cost);\r\n\t\t\t\tc.newArr.push({\r\n\t\t\t\t\tu_description_sin: item.item_id,\r\n\t\t\t\t\tu_unit_type: item.unit_type,\r\n\t\t\t\t\tu_unit_price: unitPrice.toFixed(2),\r\n\t\t\t\t\tstock_in_unit_cost: item.stock_in_unit_cost,\r\n\t\t\t\t\toldPrice: item.oldPrice ? item.oldPrice.toFixed(2) : unitPrice.toFixed(2), // ✅ ใช้ oldPrice จาก referencevalue\r\n\t\t\t\t\tu_qty: qty.toString(),\r\n\t\t\t\t\tu_total_price: (unitPrice * qty).toFixed(2),\r\n\t\t\t\t\tu_uc_code: item.uc_code || '',\r\n\t\t\t\t\tdescription: item.description || '',\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t\t// console.log('**** c.newArr =>: ' + JSON.stringify(c.newArr) + '****');\r\n\r\n\t\t// ---------- Step 2: If oldData exists, sync with newArr ----------\r\n\t\tif (c.oldData && c.oldData.length > 0) {\r\n\t\t\tc.server.get({ action: 'checkmultirow', newArr: c.newArr, oldArr: c.oldData }).then((r) => {\r\n\t\t\t\tconst oldArr = (r.data.oldArr || []).map((item) => ({ ...item }));\r\n\r\n\t\t\t\t// Build index for quick lookup\r\n\t\t\t\tconst newMap = Object.fromEntries(c.newArr.map((n) => [n.u_description_sin, n]));\r\n\r\n\t\t\t\toldArr.forEach((item) => {\r\n\t\t\t\t\tconst match = newMap[item.u_description_sin];\r\n\t\t\t\t\tif (!match) return;\r\n\r\n\t\t\t\t\t// ✅ เก็บราคาเก่าก่อนจะอัปเดต\r\n\t\t\t\t\tif (!item.oldPrice) {\r\n\t\t\t\t\t\titem.oldPrice = toNum(item.u_unit_price).toFixed(2);\r\n\t\t\t\t\t\t// console.log('Set oldPrice for item:', item.oldPrice);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Update qty ถ้าเปลี่ยน\r\n\t\t\t\t\tconst newQty = toNum(match.u_qty);\r\n\t\t\t\t\tif (newQty !== toNum(item.u_qty)) item.u_qty = newQty;\r\n\r\n\t\t\t\t\t// Update unit price ถ้าเปลี่ยน\r\n\t\t\t\t\tconst newPrice = toNum(match.u_unit_price);\r\n\t\t\t\t\tif (newPrice !== toNum(item.u_unit_price)) {\r\n\t\t\t\t\t\titem.u_unit_price = newPrice.toFixed(2);\r\n\t\t\t\t\t\t// ❌ ไม่แตะ oldPrice เพื่อคงค่าเดิมไว้\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Recalculate total price\r\n\t\t\t\t\titem.u_total_price = (toNum(item.u_unit_price) * toNum(item.u_qty)).toFixed(2);\r\n\r\n\t\t\t\t\t// Sync UC code\r\n\t\t\t\t\tif (match.u_uc_code && match.u_uc_code !== item.u_uc_code) {\r\n\t\t\t\t\t\titem.u_uc_code = match.u_uc_code;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Sync description\r\n\t\t\t\t\tif (!item.description) {\r\n\t\t\t\t\t\titem.description = match.description || '';\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\t// Add any new rows from newArr not in oldArr\r\n\t\t\t\tc.newArr.forEach((n) => {\r\n\t\t\t\t\tif (!oldArr.find((i) => i.u_description_sin === n.u_description_sin)) {\r\n\t\t\t\t\t\toldArr.push({ ...n });\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\t// Prepare items for UC code table\r\n\t\t\t\tconst itemsForUC = oldArr.map((item) => {\r\n\t\t\t\t\t// console.log('**** oldArr =>: ' + JSON.stringify(item) + '****');\r\n\t\t\t\t\tconst copyItem = c.copyArr.find((ci) => ci.item_id === item.u_description_sin);\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\tu_description_sin: item.u_description_sin,\r\n\t\t\t\t\t\tdescription: item.description,\r\n\t\t\t\t\t\tu_unit_price: item.u_unit_price,\r\n\t\t\t\t\t\tu_unit_price: item.stock_in_unit_cost,\r\n\t\t\t\t\t\toldPrice: item.oldPrice || item.u_unit_price, // ✅ ใช้ราคาเดิมถ้ามี\r\n\t\t\t\t\t\tu_uc_code: item.u_uc_code || '',\r\n\t\t\t\t\t};\r\n\t\t\t\t});\r\n\r\n\t\t\t\tc.updateUCCode(itemsForUC);\r\n\r\n\t\t\t\t// Update final data & MRV\r\n\t\t\t\tc.olddataArr = oldArr;\r\n\t\t\t\tc.newDataArr = oldArr;\r\n\t\t\t\tc.finalData = oldArr;\r\n\t\t\t\tc.updatMRV(c.newDataArr);\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\t// ---------- First time case ----------\r\n\t\t\tc.olddataArr = c.newArr;\r\n\t\t\tc.newDataArr = c.newArr;\r\n\t\t\tc.finalData = c.newArr;\r\n\r\n\t\t\tconst itemsForUC = c.newArr.map((item) => {\r\n\t\t\t\tconst copyItem = c.copyArr.find((ci) => ci.item_id === item.u_description_sin);\r\n\r\n\t\t\t\treturn {\r\n\t\t\t\t\tu_description_sin: item.u_description_sin,\r\n\t\t\t\t\tdescription: copyItem ? copyItem.description : item.description || item.u_description_sin,\r\n\t\t\t\t\tu_unit_price: item.u_unit_price,\r\n\t\t\t\t\tstock_in_unit_cost: item.stock_in_unit_cost,\r\n\t\t\t\t\toldPrice: item.oldPrice || copyItem?.oldPrice || '',\r\n\t\t\t\t\tuc_code: copyItem ? copyItem.uc_code || '' : item.u_uc_code || '',\r\n\t\t\t\t};\r\n\t\t\t});\r\n\r\n\t\t\t// console.log('✅ itemsForUC (from backend oldPrice):', JSON.stringify(itemsForUC, null, 2));\r\n\r\n\t\t\tc.updateUCCode(itemsForUC);\r\n\t\t\tc.updatMRV(c.newDataArr);\r\n\t\t}\r\n\t};\r\n\r\n\t// ===== Update MRV =====\r\n\tc.updatMRV = function (finalData) {\r\n\t\tc.total = 0;\r\n\r\n\t\tfor (var v = 0; v < finalData.length; v++) {\r\n\t\t\tlet item = finalData[v];\r\n\r\n\t\t\t// แปลง qty และ unit_price เป็นตัวเลข\r\n\t\t\tlet qty = parseFloat(item.u_qty) || 0;\r\n\t\t\tlet unitPrice = parseFloat(item.u_unit_price.toString().replace(/,/g, '')) || 0;\r\n\r\n\t\t\tif (qty > 0) {\r\n\t\t\t\t// คำนวณ total ใหม่\r\n\t\t\t\tlet totalPrice = qty * unitPrice;\r\n\r\n\t\t\t\t// เก็บราคาที่ format แล้ว\r\n\t\t\t\titem.u_unit_price = formatCurrency(unitPrice);\r\n\t\t\t\titem.u_total_price = formatCurrency(totalPrice);\r\n\r\n\t\t\t\t// รวม total ทั้งหมด\r\n\t\t\t\tc.total += totalPrice;\r\n\t\t\t} else {\r\n\t\t\t\t// กรณี qty = 0, กำหนดราคาเป็น 0\r\n\t\t\t\titem.u_unit_price = formatCurrency(0);\r\n\t\t\t\titem.u_total_price = formatCurrency(0);\r\n\t\t\t}\r\n\r\n\t\t\t// console.log('finalData : ' + JSON.stringify(item));\r\n\t\t}\r\n\r\n\t\tc.total_display = c.total.toFixed(2).replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',');\r\n\t\t$scope.page.g_form.setValue('u_grand_price_display', '฿' + c.total_display);\r\n\t\t$scope.page.g_form.setValue('u_grand_price', c.total);\r\n\r\n\t\t$('#myModal').modal('hide');\r\n\t\t$('#myPreviewModal').modal('hide');\r\n\r\n\t\tif (finalData.length !== 0) {\r\n\t\t\t$scope.page.g_form.setValue('istationary_stock_in_item_list_cart', JSON.stringify(finalData));\r\n\t\t\tc.data.finalObject = c.copyArr;\r\n\t\t} else {\r\n\t\t\t$scope.page.g_form.setValue('istationary_stock_in_item_list_cart', '');\r\n\t\t}\r\n\t};\r\n\r\n\t// ===== FETCH OBJECT VALUE FOR PREVIEW =====\r\n\tc.fetchObjectValue = function () {\r\n\t\tconst rawMrvs = $scope.page.g_form.getValue('istationary_stock_in_item_list_cart');\r\n\t\tconst mrvs = rawMrvs ? JSON.parse(rawMrvs) : [];\r\n\r\n\t\tconsole.log('Fetching object value for preview:', mrvs);\r\n\r\n\t\tc.server.get({ action: 'referencepreviewvalue', arrdatavalue: mrvs }).then((response) => {\r\n\t\t\tconst data = response.data;\r\n\t\t\tif (!data) return;\r\n\r\n\t\t\tconst finalPreview = data.finalPreviewObject || [];\r\n\t\t\tconst previewMap = Object.fromEntries(finalPreview.map((p) => [p.item_id, p]));\r\n\t\t\t// console.log('previewMap :', previewMap);\r\n\r\n\t\t\tmrvs.forEach((m) => {\r\n\t\t\t\tm.u_unit_price = parseNumber(m.u_unit_price || 0);\r\n\t\t\t\tm.u_total_price = parseNumber(m.u_total_price || 0);\r\n\t\t\t\tm.u_qty = parseNumber(m.u_qty || 0);\r\n\t\t\t\tm.stock_in_unit_cost = formatCurrency(m.stock_in_unit_cost);\r\n\t\t\t\tm.u_unit_price_display = m.u_unit_price;\r\n\t\t\t\t// m.u_total_price_display = formatCurrency(m.u_total_price);\r\n\r\n\t\t\t\tconst previewItem = previewMap[m.u_description_sin];\r\n\t\t\t\tif (previewItem) {\r\n\t\t\t\t\tpreviewItem.unit_price = parseNumber(previewItem.unit_price || 0);\r\n\r\n\t\t\t\t\tif (m.u_unit_price !== previewItem.unit_price) {\r\n\t\t\t\t\t\tpreviewItem.unit_price = m.u_unit_price;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tpreviewItem.uc_code = m.u_uc_code || previewItem.uc_code || '';\r\n\t\t\t\t}\r\n\t\t\t\t// console.log(' previewItem.unit_price :', previewItem.unit_price);\r\n\t\t\t});\r\n\r\n\t\t\t// Ensure number\r\n\t\t\tfinalPreview.forEach((p) => {\r\n\t\t\t\tp.unit_price = parseNumber(p.unit_price || 0);\r\n\t\t\t\tp.total_price = parseNumber(p.total_price || 0);\r\n\t\t\t\tp.qty = parseNumber(p.qty || 0);\r\n\t\t\t\tp.stock_in_unit_cost = formatCurrency(p.stock_in_unit_cost);\r\n\t\t\t});\r\n\r\n\t\t\tc.data.finalPreviewObject = finalPreview;\r\n\t\t\tc.copyObjectArr = JSON.parse(JSON.stringify(finalPreview));\r\n\t\t\tc.previewOBJ = c.copyObjectArr;\r\n\r\n\t\t\tconst totalNumber = parseNumber(data.grand_price);\r\n\t\t\t// console.log('totalNumber :', totalNumber);\r\n\r\n\t\t\tconst totalDisplay = formatCurrency(data.grand_price);\r\n\t\t\t// console.log('totalDisplay :', totalDisplay);\r\n\r\n\t\t\tc.total_display = totalDisplay;\r\n\t\t\t$scope.page.g_form.setValue('u_grand_price', totalNumber);\r\n\t\t\t$scope.page.g_form.setValue('u_grand_price_display', '฿' + totalDisplay);\r\n\t\t});\r\n\t};\r\n\r\n\t$scope.showLargeImage = function (imgUrl) {\r\n\t\tvar html = '<div align=\"center\">';\r\n\t\tif (imgUrl == '') {\r\n\t\t\thtml += '<img ng-src=\"No%20Image.png\" height=\"500\" />';\r\n\t\t} else {\r\n\t\t\thtml +=\r\n\t\t\t\t'<img ng-src=\"' +\r\n\t\t\t\timgUrl +\r\n\t\t\t\t'\" height=\"500\" onclick=\"window.open(' +\r\n\t\t\t\timgUrl +\r\n\t\t\t\t', _blank);\"/>';\r\n\t\t}\r\n\t\thtml += '</div>';\r\n\t\tc.largeImage = $uibModal\r\n\t\t\t.open({\r\n\t\t\t\ttemplate: html,\r\n\t\t\t})\r\n\t\t\t.then(function () {});\r\n\t};\r\n\r\n\t// ===== UPDATE PRICE FROM INPUT =====\r\n\t$scope.updatePrice = function (item) {\r\n\t\t// console.log('Updating price for item:', item);\r\n\t\tconst parseNumber = (value) => parseFloat((value || '0').toString().replace(/,/g, '')) || 0;\r\n\t\tconst formatNumber = (value) =>\r\n\t\t\tparseFloat(value)\r\n\t\t\t\t.toFixed(2)\r\n\t\t\t\t.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',');\r\n\r\n\t\tconst unitPrice = parseNumber(item.unit_price);\r\n\t\tconst quantity = parseNumber(item.qty);\r\n\t\tconst previousTotal = parseNumber(item.totalPrice);\r\n\t\tconst currentTotalDisplay = parseNumber(c.total_display);\r\n\r\n\t\t// Subtract the old total price of the item from the current total display\r\n\t\tlet newTotalDisplay = currentTotalDisplay - previousTotal;\r\n\r\n\t\t// Calculate new item total price\r\n\t\tlet newItemTotal = 0;\r\n\t\tif (quantity > 0 && unitPrice > 0) {\r\n\t\t\tnewItemTotal = quantity * unitPrice;\r\n\t\t\titem.totalPrice = formatNumber(newItemTotal);\r\n\t\t\tnewTotalDisplay += newItemTotal;\r\n\t\t} else {\r\n\t\t\titem.totalPrice = formatNumber(0);\r\n\t\t}\r\n\r\n\t\t// Update the display total\r\n\t\tc.total_display = formatNumber(newTotalDisplay);\r\n\t};\r\n\r\n\t// ===== UPDATE CART =====\r\n\tc.updateCart = function () {\r\n\t\tc.finalData = [];\r\n\t\tc.previewData = [];\r\n\t\tc.newArr = [];\r\n\t\tc.olddataArr = [];\r\n\r\n\t\t// Get old cart data\r\n\t\tvar oldDataStr = $scope.page.g_form.getValue('istationary_stock_in_item_list_cart');\r\n\t\tc.oldData = JSON.parse(oldDataStr);\r\n\r\n\t\t// Build newArr from previewOBJ\r\n\t\tfor (var y = 0; y < c.previewOBJ.length; y++) {\r\n\t\t\tvar newData = {\r\n\t\t\t\tu_description_sin: c.previewOBJ[y].item_id,\r\n\t\t\t\tu_unit_type: c.previewOBJ[y].unit_type,\r\n\t\t\t\tu_unit_price: c.previewOBJ[y].unit_price,\r\n\t\t\t\tstock_in_unit_cost: c.previewOBJ[y].stock_in_unit_cost,\r\n\t\t\t\tu_qty: c.previewOBJ[y].qty.toString(),\r\n\t\t\t\tu_total_price: c.previewOBJ[y].totalPrice,\r\n\t\t\t};\r\n\t\t\tc.newArr.push(newData);\r\n\t\t}\r\n\r\n\t\t// Call server previewUpdate\r\n\t\tc.server\r\n\t\t\t.get({\r\n\t\t\t\taction: 'previewUpdate',\r\n\t\t\t\tnewArr: c.newArr,\r\n\t\t\t\toldArr: c.oldData,\r\n\t\t\t})\r\n\t\t\t.then(function (r) {\r\n\t\t\t\tconst oldArr = (r.data.oldArr || []).map((oldItem) => {\r\n\t\t\t\t\tconst match = c.previewOBJ.find((p) => p.item_id === oldItem.u_description_sin);\r\n\r\n\t\t\t\t\t// Convert string to number before comparing\r\n\t\t\t\t\tconst oldPriceNum = parseNumber(oldItem.u_unit_price);\r\n\t\t\t\t\tconst newPriceNum = match ? parseNumber(match.unit_price) : oldPriceNum;\r\n\r\n\t\t\t\t\tif (oldPriceNum !== newPriceNum) {\r\n\t\t\t\t\t\treturn { ...oldItem, u_unit_price: formatCurrency(newPriceNum) };\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn { ...oldItem, u_unit_price: formatCurrency(oldItem.u_unit_price) };\r\n\t\t\t\t});\r\n\r\n\t\t\t\t// Save the processed array\r\n\t\t\t\tc.olddataArr = oldArr;\r\n\t\t\t\tc.newDataArr = c.olddataArr;\r\n\r\n\t\t\t\t// Call functions to update UC Code and MRV\r\n\t\t\t\tc.updateUCCode(c.newDataArr);\r\n\t\t\t\tc.updatMRV(c.newDataArr);\r\n\t\t\t});\r\n\t};\r\n};\r\n",
            "max_length": 8000,
            "ed": {
                "name": "client_script"
            }
        },
        "data_table": {
            "sys_mandatory": true,
            "visible": true,
            "dbType": 12,
            "default_value": "sp_instance",
            "label": "Data table",
            "sys_readonly": false,
            "type": "table_name",
            "mandatory": true,
            "displayValue": "sp_instance",
            "readonly": false,
            "hint": "",
            "name": "data_table",
            "attributes": {
                "base_table": "sp_instance",
                "base_start": "true"
            },
            "choice": 0,
            "choices": [],
            "value": "sp_instance",
            "max_length": 80,
            "ed": {
                "name": "data_table"
            }
        },
        "name": {
            "sys_mandatory": true,
            "visible": true,
            "dbType": 12,
            "label": "Name",
            "sys_readonly": false,
            "type": "translated_field",
            "mandatory": true,
            "displayValue": "IStationery Stock-In Order NOW",
            "readonly": false,
            "hint": "",
            "name": "name",
            "attributes": {
                "edge_encryption_enabled": "true"
            },
            "choice": 0,
            "value": "IStationery Stock-In Order NOW",
            "max_length": 40,
            "ed": {
                "name": "name"
            }
        },
        "sys_scope": {
            "sys_mandatory": false,
            "visible": true,
            "table_attributes": {
                "metadata_link_exempt": "true"
            },
            "dbType": 12,
            "label": "Application",
            "sys_readonly": true,
            "type": "reference",
            "mandatory": false,
            "refTable": "sys_scope",
            "reference_type": "table",
            "displayValue": "Global",
            "readonly": true,
            "hint": "Application containing this record",
            "name": "sys_scope",
            "attributes": {
                "list_force_default": "true",
                "readonly_clickthrough": "true",
                "ignore_filter_on_new": "true"
            },
            "reference_key": "sys_id",
            "readonlyClickthrough": true,
            "choice": 0,
            "value": "global",
            "max_length": 32,
            "ed": {
                "reference": "sys_scope",
                "searchField": "name",
                "defaultOperator": "STARTSWITH",
                "name": "sys_scope"
            }
        },
        "id": {
            "sys_mandatory": false,
            "visible": true,
            "dbType": 12,
            "label": "ID",
            "sys_readonly": false,
            "type": "string",
            "mandatory": false,
            "displayValue": "ist_stock_in_order_now",
            "readonly": false,
            "hint": "Identifier for $sp.embedWidget()",
            "name": "id",
            "attributes": {
                "edge_encryption_enabled": "true"
            },
            "choice": 0,
            "value": "ist_stock_in_order_now",
            "max_length": 40,
            "ed": {
                "name": "id"
            }
        },
        "field_list": {
            "sys_mandatory": false,
            "visible": true,
            "dependentField": "data_table",
            "dbType": -1,
            "label": "Fields",
            "sys_readonly": false,
            "type": "field_list",
            "mandatory": false,
            "displayValue": "",
            "readonly": false,
            "hint": "",
            "name": "field_list",
            "attributes": {
                "is_multi_text": "false"
            },
            "choice": 0,
            "value": "",
            "max_length": 1000,
            "ed": {
                "dependent_value": "sp_instance",
                "name": "field_list"
            }
        },
        "controller_as": {
            "sys_mandatory": false,
            "visible": true,
            "dbType": 12,
            "label": "controllerAs",
            "sys_readonly": false,
            "type": "string",
            "mandatory": false,
            "displayValue": "c",
            "readonly": false,
            "hint": "Identifier name for a reference to the controller in the directive's scope",
            "name": "controller_as",
            "attributes": {
                "edge_encryption_enabled": "true"
            },
            "choice": 0,
            "value": "c",
            "max_length": 100,
            "ed": {
                "name": "controller_as"
            }
        }
    }
}